{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/rails-7-adds-arguments-to-lock-with","result":{"data":{"markdownRemark":{"id":"922d5877-3827-5418-ac47-99648ae66b6f","html":"<p>When it comes to concurrency control, there are specifically two mechanisms\naround it - pessimistic\nand optimistic locking.</p>\n<p><strong>Optimistic locking</strong></p>\n<p>The optimistic locking model is a concurrency control technique in which\nmultiple users are allowed to update the same record without informing the users\nthat others are also attempting to update the record.\nThe record changes are validated only when the record is committed.\nIf one user successfully updates the record,\nthe other users attempting to commit their concurrent updates are informed that a conflict exists.</p>\n<p>An advantage of the optimistic locking model is that\nit avoids the overhead of locking a record for the duration of the action.\nIf there are no simultaneous updates,\nthen this model provides fast updates.</p>\n<p><strong>Pessimistic locking</strong></p>\n<p>The pessimistic locking model prevents simultaneous updates to records.\nAs soon as one user starts to update a record,\na lock is placed on it.\nOther users who attempt to update this record are informed\nthat another user has an update in progress.\nThe other users must wait until the first user has finished committing their changes,\nthereby releasing the record lock.\nOnly then can another user make changes based on the previous user’s changes.</p>\n<p>An advantage of the pessimistic locking model is that\nit avoids the issue of conflict resolution by preventing conflicts.\nUpdates are serialized\nand each subsequent update starts with\nthe committed record changes from the previous user.</p>\n<p><strong>lock!</strong></p>\n<p>In Rails\n<a href=\"https://edgeapi.rubyonrails.org/classes/ActiveRecord/Locking/Pessimistic.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">ActiveRecord::Locking::Pessimistic</code></a>\nprovides support for row-level locking using the <code class=\"language-text\">lock!</code> method wrapped inside a transaction for example:- </p>\n<p>If two users press the like button for an article,\nat the same time then instead of the like_count of that article going up to 2,\nit will only increment to 1, because both users pressed increment\nfrom 0 to 1 at the same time.\nTo fix this we can use <code class=\"language-text\">lock!</code> wrapped inside a transaction.</p>\n<p>{% highlight ruby %}\nActiveRecord::Base.transaction do\narticle = Article.find(“00000000-0000-0000-0000-000000000001”).lock!(“FOR UPDATE NOWAIT”)\narticle.like_count += 1\narticle.save!\nend\n{% endhighlight %}</p>\n<p>What the code does here is\nfirst, it starts a database transaction.\nSecond, it acquires a pessimistic database lock.\nOnce the lock is acquired, the record is reloaded in memory,\nso that the values on the record match those in the locked database row.\nThe lock will prevent others from reading or writing to that row\nand anyone else trying to acquire a lock will have to wait for the lock to be released.</p>\n<p>Also, we can pass various\n<a href=\"https://www.postgresql.org/docs/9.1/sql-select.html#SQL-FOR-UPDATE-SHARE\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">locking strategies</a>\nto the <code class=\"language-text\">lock!</code> method as supported by the underlying Database\nfor example, we used <code class=\"language-text\">FOR UPDATE NOWAIT</code> on Postgres DB\nwhat it means is other transactions that attempt UPDATE, DELETE,\nor SELECT FOR UPDATE on this row will be blocked\nuntil the current transaction ends\nand suppose another transaction tries to acquire a lock on the same record\nthen it will result in the below error.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">TRANSACTION</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.9</span>ms<span class=\"token punctuation\">)</span>  <span class=\"token constant\">ROLLBACK</span>\n<span class=\"token operator\">/</span>Users<span class=\"token regex-literal\"><span class=\"token regex\">/murtazabagwala/</span></span><span class=\"token punctuation\">.</span>rvm<span class=\"token operator\">/</span>gems<span class=\"token operator\">/</span>ruby<span class=\"token operator\">-</span><span class=\"token number\">3.0</span><span class=\"token number\">.1</span><span class=\"token operator\">/</span>gems<span class=\"token operator\">/</span>activerecord<span class=\"token operator\">-</span><span class=\"token number\">6.1</span><span class=\"token number\">.4</span><span class=\"token number\">.1</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>active_record<span class=\"token operator\">/</span>connection_adapters<span class=\"token operator\">/</span>postgresql_adapter<span class=\"token punctuation\">.</span>rb<span class=\"token operator\">:</span><span class=\"token number\">672</span><span class=\"token symbol\">:in</span> `exec_params'<span class=\"token operator\">:</span> <span class=\"token constant\">PG</span><span class=\"token double-colon punctuation\">::</span>LockNotAvailable<span class=\"token operator\">:</span> <span class=\"token constant\">ERROR</span><span class=\"token operator\">:</span>  could <span class=\"token keyword\">not</span> obtain lock on row <span class=\"token keyword\">in</span> relation <span class=\"token string-literal\"><span class=\"token string\">\"articles\"</span></span> <span class=\"token punctuation\">(</span>ActiveRecord<span class=\"token double-colon punctuation\">::</span>LockWaitTimeout<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">/</span>Users<span class=\"token regex-literal\"><span class=\"token regex\">/murtazabagwala/</span></span><span class=\"token punctuation\">.</span>rvm<span class=\"token operator\">/</span>gems<span class=\"token operator\">/</span>ruby<span class=\"token operator\">-</span><span class=\"token number\">3.0</span><span class=\"token number\">.1</span><span class=\"token operator\">/</span>gems<span class=\"token operator\">/</span>activerecord<span class=\"token operator\">-</span><span class=\"token number\">6.1</span><span class=\"token number\">.4</span><span class=\"token number\">.1</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>active_record<span class=\"token operator\">/</span>connection_adapters<span class=\"token operator\">/</span>postgresql_adapter<span class=\"token punctuation\">.</span>rb<span class=\"token operator\">:</span><span class=\"token number\">672</span><span class=\"token symbol\">:in</span> `exec_params'<span class=\"token operator\">:</span> <span class=\"token constant\">ERROR</span><span class=\"token operator\">:</span>  could <span class=\"token keyword\">not</span> obtain lock on row <span class=\"token keyword\">in</span> relation <span class=\"token string-literal\"><span class=\"token string\">\"articles\"</span></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">PG</span><span class=\"token double-colon punctuation\">::</span>LockNotAvailable<span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>with_lock</strong></p>\n<p>We can make it more concise using <code class=\"language-text\">with_lock</code>.\n<code class=\"language-text\">with_lock</code> does the same thing it creates a transaction\nand applies a lock on the record under the hood.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  article <span class=\"token operator\">=</span> Article<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"00000000-0000-0000-0000-000000000001\"</span></span><span class=\"token punctuation\">)</span>\n  article<span class=\"token punctuation\">.</span>with_lock<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"FOR UPDATE NOWAIT\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n    article<span class=\"token punctuation\">.</span>like_count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    article<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span> \n  <span class=\"token keyword\">end</span></code></pre></div>\n<p>But, before Rails 7\nthere was no way to specify transaction arguments like\n<code class=\"language-text\">isolation</code>, <code class=\"language-text\">requires_new</code> and <code class=\"language-text\">joinable</code> to <code class=\"language-text\">with_lock</code>\nso, for example before Rails 7\nif we had to create the nested transactions\nwe had to use multiple transaction blocks with <code class=\"language-text\">lock!</code>.</p>\n<h4 id=\"before\" style=\"position:relative;\"><a href=\"#before\" aria-label=\"before permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Before</h4>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base<span class=\"token punctuation\">.</span>transaction <span class=\"token keyword\">do</span>\n    article <span class=\"token operator\">=</span> Article<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"00000000-0000-0000-0000-000000000001\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>lock<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"FOR UPDATE NOWAIT\"</span></span><span class=\"token punctuation\">)</span>\n    article<span class=\"token punctuation\">.</span>like_count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    article<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span> \n\n    ActiveRecord<span class=\"token double-colon punctuation\">::</span>Base<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">(</span><span class=\"token symbol\">requires_new</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n      author <span class=\"token operator\">=</span> article<span class=\"token punctuation\">.</span>author<span class=\"token punctuation\">.</span>lock<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"FOR UPDATE NOWAIT\"</span></span><span class=\"token punctuation\">)</span>\n      author<span class=\"token punctuation\">.</span>articles_liked <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n      author<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span> \n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span></code></pre></div>\n<h4 id=\"after\" style=\"position:relative;\"><a href=\"#after\" aria-label=\"after permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>After</h4>\n<p>After Rails 7 we can use <code class=\"language-text\">with_lock</code> to create nested transactions\nand can specify transaction optional arguments like:-</p>\n<ul>\n<li><code class=\"language-text\">requires_new</code>: If this is set to <code class=\"language-text\">true</code> then the block will be wrapped in a database savepoint acting as a sub-transaction.</li>\n<li><code class=\"language-text\">isolation</code>: We can specify the <a href=\"https://www.postgresql.org/docs/current/transaction-iso.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Isolation Levels</a> to avoid dirty reads.</li>\n<li><code class=\"language-text\">joinable</code>: This can be set to <code class=\"language-text\">false</code> to avoid <a href=\"https://makandracards.com/makandra/42885-nested-activerecord-transaction-pitfalls\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">surprises while dealing with custom nested transactions</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  article <span class=\"token operator\">=</span> Article<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"00000000-0000-0000-0000-000000000001\"</span></span><span class=\"token punctuation\">)</span>\n\n  article<span class=\"token punctuation\">.</span>with_lock <span class=\"token keyword\">do</span>\n    author <span class=\"token operator\">=</span> article<span class=\"token punctuation\">.</span>author\n    article<span class=\"token punctuation\">.</span>like_count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n    article<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span> \n\n    <span class=\"token comment\"># Will create a new transaction called sub-transaction/savepoint.</span>\n    <span class=\"token comment\"># And, in case of error it will rollback to this savepoint and will not rollback parent transaction</span>\n\n    author<span class=\"token punctuation\">.</span>with_lock<span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"FOR UPDATE NOWAIT\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">requires_new</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">do</span>\n      author<span class=\"token punctuation\">.</span>articles_liked <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n      author<span class=\"token punctuation\">.</span>save<span class=\"token operator\">!</span> \n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span></code></pre></div>\n<p>Please <a href=\"https://github.com/rails/rails/pull/43224\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">refer to this PR</a>.</p>","fields":{"slug":"/posts/rails-7-adds-arguments-to-lock-with","tagSlugs":["/tag/rails/","/tag/rails-7/"]},"frontmatter":{"date":"2022-03-23T18:00:37.121Z","description":"With Rails 7 we can pass transaction arguments like isolation, joinable, etc directly to with_lock.","tags":["rails","rails-7"],"title":"Rails 7 adds optional transaction arguments to with_lock","socialImage":null}}},"pageContext":{"slug":"/posts/rails-7-adds-arguments-to-lock-with"}},"staticQueryHashes":["251939775","401334301","984292147"]}