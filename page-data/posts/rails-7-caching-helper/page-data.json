{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/rails-7-caching-helper/","result":{"data":{"markdownRemark":{"id":"8d99493a-a17e-5d63-bb43-c0b148ce93e1","html":"<p>We often hear <em><strong>Cache invalidation is a hard problem in computer science and could cause bugs</strong></em>\nbut sometimes, caching something that should not be cached is a potential source of bugs\nand security vulnerabilities.\nRails has a built-in mechanism for <a href=\"https://guides.rubyonrails.org/caching_with_rails.html#fragment-caching\">Fragment Caching</a>,\nwhich stores part of the rendered view as a fragment.\nFor subsequent requests, the pre-saved fragment is used instead of rendering it again.</p>\n<p>But this could cause some serious bugs!\nFor example, we could have an S3 URL helper which generates a unique presigned URL\nfor each product\nor one could write a form helper that outputs a request-specific auth token.\nIn such cases, it is better to avoid fragment caching.</p>\n<h3>Before</h3>\n<p>We can implement fragment caching using the <code class=\"language-text\">cache</code> helper.</p>\n<p><strong>views/products/index.html.erb</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>table<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>thead<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Title<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Description<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span>Image<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>thead<span class=\"token operator\">></span>\n\n    <span class=\"token operator\">&lt;</span>tbody<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token variable\">@products</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>product<span class=\"token operator\">|</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n          &lt;% cache(product) do %></span></span>\n              <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> render product <span class=\"token string-literal\"><span class=\"token string\">%>\n          &lt;% end %></span></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">end</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n    &lt;/tbody></span></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span></code></pre></div>\n<p><strong>views/products/_product.html.erb</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> image_tag<span class=\"token punctuation\">(</span>generate_presigned_url<span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span>image_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span></code></pre></div>\n<p>But there is a bug because\nwe get a cached version of the product each time we render\ndespite generating a unique presigned URL each time.\nTo resolve this,\nwe need to include <code class=\"language-text\">cacheable</code> in the Product partial.\nIf someone tries to cache the product partial,\nit will throw an <code class=\"language-text\">ActionView::Template::Error</code> error.</p>\n<h3>After</h3>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> uncacheable<span class=\"token operator\">!</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n    &lt;td></span></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> image_tag<span class=\"token punctuation\">(</span>generate_presigned_url<span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span>image_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span></code></pre></div>\n<p>which would result in,</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">\n  ActionView<span class=\"token double-colon punctuation\">::</span>Template<span class=\"token double-colon punctuation\">::</span>Error <span class=\"token punctuation\">(</span>can't be fragment cached<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>\n    <span class=\"token number\">1</span><span class=\"token operator\">:</span> <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token number\">2</span><span class=\"token operator\">:</span>     <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> uncacheable<span class=\"token operator\">!</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n    3:   &lt;td></span></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token number\">4</span><span class=\"token operator\">:</span>   <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token number\">5</span><span class=\"token operator\">:</span>   <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> image_tag<span class=\"token punctuation\">(</span>generate_presigned_url<span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span>image_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n\n  app<span class=\"token operator\">/</span>views<span class=\"token operator\">/</span>products<span class=\"token operator\">/</span>_product<span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span>erb<span class=\"token operator\">:</span><span class=\"token number\">2</span>\n</code></pre></div>\n<p>We can also use the <code class=\"language-text\">caching?</code> helper to check whether the current code path is being cached\nor to enforce caching.</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> <span class=\"token keyword\">raise</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span> <span class=\"token string-literal\"><span class=\"token string\">\"This partial needs to be cached\"</span></span> <span class=\"token keyword\">unless</span> caching<span class=\"token operator\">?</span> <span class=\"token string-literal\"><span class=\"token string\">%>\n    &lt;td></span></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token string-literal\"><span class=\"token string\">%>&lt;/td></span></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span></code></pre></div>\n<p>For more discussion related to this change,\nplease refer to\n<a href=\"https://github.com/rails/rails/pull/42365\">this PR</a>.</p>","fields":{"slug":"/posts/rails-7-caching-helper","tagSlugs":["/tag/rails/","/tag/rails-7/"]},"frontmatter":{"date":"2021-12-20T18:00:37.121Z","description":"Starting with Rails 7, we can add caching? helper to check whether the current code path is being cached and uncacheable! helper to avoid fragment caching.","tags":["rails","rails-7"],"title":"Rails 7 adds caching? and uncachable! helper","socialImage":null}}},"pageContext":{"slug":"/posts/rails-7-caching-helper"}},"staticQueryHashes":["2246977889","2727970573","984292147"],"slicesMap":{}}