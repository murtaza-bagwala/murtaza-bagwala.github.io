{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/rails-7-adds-deferred-constraint","result":{"data":{"markdownRemark":{"id":"e869d053-2edb-508b-a152-34b69fbccf1b","html":"<hr>\n<p>title: Rails 7 adds optional transaction arguments to with_lock\ndate: “2022-03-23T18:00:37.121Z”\ntemplate: “post”\ndraft: false\nslug: “8-ways-to-handle-state-management-part-2”\ncategory: “State Normalization”\ntags:</p>\n<ul>\n<li>“rails”</li>\n<li>\n<p>“rails-7”\ndescription: “With Rails 7 we can pass transaction arguments like isolation, joinable, etc directly to with_lock.”</p>\n<hr>\n</li>\n</ul>\n<p>In the database, the Foreign Key constraint enforces referential integrity.\nThis ensures the parent record has to be present before creating a child record\nand these constraints are immediately enforced(checked after each statement).\nBut, this behavior can be changed within a transaction by changing a constraints <code class=\"language-text\">deferrable</code> characteristics,\nwhich means instead of checking the constraints immediately, these checks will be deferred until the transaction is committed\nand PostgreSQL supports this feature in which constraints <a href=\"https://www.postgresql.org/docs/9.2/sql-set-constraints.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">can be deferred</a></p>\n<p>So, before Rails 7, we had to write a raw SQL in migrations to use the <code class=\"language-text\">deferrable</code> constraints in Postgres.</p>\n<h4 id=\"before\" style=\"position:relative;\"><a href=\"#before\" aria-label=\"before permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Before</h4>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># /db/migrate/20220322071034_add_foreign_key_to_reviews.rb</span>\n\nadd_foreign_key <span class=\"token symbol\">:reviews</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:products</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Product</span><span class=\"token punctuation\">.</span>transaction <span class=\"token keyword\">do</span>\n  review <span class=\"token operator\">=</span> <span class=\"token constant\">Review</span><span class=\"token punctuation\">.</span>create<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">:</span> <span class=\"token string\">\"amazing product\"</span><span class=\"token punctuation\">)</span>\n  product <span class=\"token operator\">=</span> <span class=\"token constant\">Product</span><span class=\"token punctuation\">.</span>create<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hand Sanitizer\"</span><span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"new sanitizer in town\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>It will result in the below error</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">TRANSACTION</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span>ms<span class=\"token punctuation\">)</span>  <span class=\"token constant\">ROLLBACK</span>\n<span class=\"token operator\">/</span><span class=\"token constant\">Users</span><span class=\"token regex\">/murtazabagwala/</span><span class=\"token punctuation\">.</span>rvm<span class=\"token operator\">/</span>gems<span class=\"token operator\">/</span>ruby<span class=\"token operator\">-</span><span class=\"token number\">3.0</span><span class=\"token number\">.2</span><span class=\"token operator\">/</span>gems<span class=\"token operator\">/</span>activerecord<span class=\"token operator\">-</span><span class=\"token number\">7.0</span><span class=\"token number\">.2</span><span class=\"token number\">.3</span><span class=\"token operator\">/</span>lib<span class=\"token operator\">/</span>active_record<span class=\"token operator\">/</span>connection_adapters<span class=\"token operator\">/</span>postgresql_adapter<span class=\"token punctuation\">.</span>rb<span class=\"token punctuation\">:</span><span class=\"token number\">768</span><span class=\"token symbol\">:in</span> `exec_params'<span class=\"token punctuation\">:</span> <span class=\"token constant\">PG</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">ForeignKeyViolation</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">ERROR</span><span class=\"token punctuation\">:</span>  insert <span class=\"token keyword\">or</span> update on table <span class=\"token string\">\"reviews\"</span> violates foreign key constraint <span class=\"token string\">\"fk_rails_bedd9094d4\"</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">InvalidForeignKey</span><span class=\"token punctuation\">)</span>\n<span class=\"token constant\">DETAIL</span><span class=\"token punctuation\">:</span>  <span class=\"token constant\">Key</span> <span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> is <span class=\"token keyword\">not</span> present <span class=\"token keyword\">in</span> table <span class=\"token string\">\"products\"</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h4 id=\"after\" style=\"position:relative;\"><a href=\"#after\" aria-label=\"after permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>After</h4>\n<p>But, in Rails 7, while passing the <code class=\"language-text\">:deferrable</code> option to the <code class=\"language-text\">add_foreign_key</code> statement in migrations,\nit is possible to defer this check.</p>\n<p>We can specify whether\nor not the foreign key should be deferrable.\nValid values are booleans or <code class=\"language-text\">:deferred</code> or <code class=\"language-text\">:immediate</code>.</p>\n<ul>\n<li><code class=\"language-text\">deferrable: false</code>:- Default value, constraint check is always immediate.</li>\n<li><code class=\"language-text\">deferrable: true</code> :- Doesn’t change the default behavior,\nbut allows <a href=\"https://www.postgresql.org/docs/9.2/sql-set-constraints.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">manually deferring the check within a transaction</a>.</li>\n<li><code class=\"language-text\">deferrable: :deferred</code> :- Constraint check will be done once the transaction is committed\nand allows the <a href=\"https://www.postgresql.org/docs/9.2/sql-set-constraints.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">constraint behavior to change within transaction</a>.</li>\n<li><code class=\"language-text\">deferrable: :immediate</code> :- Constraint check is immediate\nand allows the <a href=\"https://www.postgresql.org/docs/9.2/sql-set-constraints.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">constraint behavior to change within transaction</a>.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># /db/migrate/20220322071050_add_foreign_key_to_reviews.rb</span>\n\nadd_foreign_key <span class=\"token symbol\">:reviews</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:products</span><span class=\"token punctuation\">,</span> deferrable<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:deferred</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Product</span><span class=\"token punctuation\">.</span>transaction <span class=\"token keyword\">do</span>\n  review <span class=\"token operator\">=</span> <span class=\"token constant\">Review</span><span class=\"token punctuation\">.</span>create<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>product_id<span class=\"token punctuation\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> comment<span class=\"token punctuation\">:</span> <span class=\"token string\">\"amazing product\"</span><span class=\"token punctuation\">)</span>\n  product <span class=\"token operator\">=</span> <span class=\"token constant\">Product</span><span class=\"token punctuation\">.</span>create<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hand Sanitizer\"</span><span class=\"token punctuation\">,</span> description<span class=\"token punctuation\">:</span> <span class=\"token string\">\"new sanitizer in town\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Records will be created successfully</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">TRANSACTION</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.2</span>ms<span class=\"token punctuation\">)</span>  <span class=\"token keyword\">BEGIN</span>\n<span class=\"token constant\">Review</span> <span class=\"token constant\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.7</span>ms<span class=\"token punctuation\">)</span>  <span class=\"token constant\">INSERT</span> <span class=\"token constant\">INTO</span> <span class=\"token string\">\"reviews\"</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"comment\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"created_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"updated_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"product_id\"</span><span class=\"token punctuation\">)</span> <span class=\"token constant\">VALUES</span> <span class=\"token punctuation\">(</span>$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">2</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">3</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token constant\">RETURNING</span> <span class=\"token string\">\"id\"</span>  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"comment\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"amazing product\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"created_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2022-03-22 07:44:17.296514\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"updated_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2022-03-22 07:44:17.296514\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"product_id\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token constant\">Product</span> <span class=\"token constant\">Create</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.5</span>ms<span class=\"token punctuation\">)</span>  <span class=\"token constant\">INSERT</span> <span class=\"token constant\">INTO</span> <span class=\"token string\">\"products\"</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"created_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"updated_at\"</span><span class=\"token punctuation\">)</span> <span class=\"token constant\">VALUES</span> <span class=\"token punctuation\">(</span>$<span class=\"token number\">1</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">2</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">3</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">4</span><span class=\"token punctuation\">,</span> $<span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token constant\">RETURNING</span> <span class=\"token string\">\"id\"</span>  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Hand Sanitizer\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"description\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"new sanitizer in town\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"created_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2022-03-22 07:44:17.306941\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"updated_at\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2022-03-22 07:44:17.306941\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token constant\">TRANSACTION</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2.4</span>ms<span class=\"token punctuation\">)</span>  <span class=\"token constant\">COMMIT</span></code></pre></div>\n<p>Check out this <a href=\"https://github.com/rails/rails/pull/41487\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pull request</a> to know about the change.</p>","fields":{"slug":"/posts/rails-7-adds-deferred-constraint","tagSlugs":["/tag/rails/","/tag/rails-7/"]},"frontmatter":{"date":"2022-03-29T18:00:37.121Z","description":"By default, foreign key constraints in PostgreSQL are checked after each statement. This works for most use cases but becomes a major limitation when creating related records before the parent record is inserted into the database.","tags":["rails","rails-7"],"title":"Rails 7 adds support for deferrable foreign key constraints in PostgreSQL","socialImage":null}}},"pageContext":{"slug":"/posts/rails-7-adds-deferred-constraint"}}}