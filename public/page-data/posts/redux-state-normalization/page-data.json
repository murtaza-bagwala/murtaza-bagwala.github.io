{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/redux-state-normalization","result":{"data":{"markdownRemark":{"id":"dfb52628-d9d3-5f6b-b1f9-9c3442cab172","html":"<p><strong>Normalization</strong> is the process of efficiently organizing data.\nIn the case of the backend, we generally store the data in the database\nand apply some normalization techniques to eliminate redundant data\n(for example, storing the same data in more than one table)\nand ensuring data dependencies make sense (only storing related data in a table).</p>\n<p>Traditionally, client-side applications were only used to show\nthe data coming from the backend with minimal business logic.\nBut with the advent of SPA and various libraries around it like\n<a href=\"https://reactjs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">React</a>\nand\n<a href=\"https://vuejs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Vue</a>\netc., client applications have now evolved, have become more complex and,\nnow they are capable of managing the data as well.\nSo, to store and manage the data,\nwe use some state management tools like\n<a href=\"https://redux.js.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Redux</a>.</p>\n<p>The idea of Redux is simple: the whole state of the application\nis contained in one central location. We need to define Action Types/Creators,\nPure Reducers, and Store that is it.</p>\n<p>Before getting into the <strong>Normalization</strong>, let us see how data flows in Redux.</p>\n<p><img src=\"/redux-async-data-flow.gif\" alt=\"alt\"></p>\n<p><a href=\"https://redux.js.org/tutorials/fundamentals/part-6-async-logic#redux-async-data-flow\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Image Credit</a></p>\n<p>The work done by Redux generally falls into two major areas:</p>\n<ol>\n<li>Processing actions in middleware(calling an API).</li>\n<li>Calling the Reducers to update the state (including object duplication for immutable updates).</li>\n</ol>\n<p>It is certainly possible for each of these to become a performance concern\nin complex situations.\nWe can increase the performance by improving the state shape.</p>\n<p>Let us understand how denormalized state shape could be a performance bottleneck.\nSuppose we are building an online Chat room.\nHere our data would be nested in nature.\nFor example, each Chat room has multiple users and,\neach user would belong to multiple Chat rooms.\nData for this kind of application might look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> chatRooms <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'general'</span><span class=\"token punctuation\">,</span>\n    users<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token string\">'user1'</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'John'</span>\n        belongToRooms<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'general'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'random'</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token string\">'user2'</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'Smith'</span>\n        belongToRooms<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'general'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'random'</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'random'</span><span class=\"token punctuation\">,</span>\n    users<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token string\">'user1'</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'John'</span>\n        belongToRooms<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'general'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'random'</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> <span class=\"token string\">'user2'</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'Smith'</span>\n        belongToRooms<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'general'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'random'</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>The structure of this data is a bit complex, and some of the data is repeated.\nLet us see, how our reducer would look like if we need to delete/update the particular Chat room.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DELETE_CHAT_ROOM</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> roomId <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">;</span> \n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> chatRooms <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> indexOfChatRoomToBeDeleted <span class=\"token operator\">=</span> chatRooms<span class=\"token punctuation\">.</span><span class=\"token function\">findIndex</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chatRoom</span> <span class=\"token operator\">=></span> chatRoom<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> roomId<span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// Delete Chat room</span>\n\n      chatRooms<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>indexOfChatRoomToBeDeleted<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n       <span class=\"token comment\">// Delete Chat room from the users</span>\n\n      chatRooms<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chatRoom</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        chatRoom<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          \n          <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> \n            user<span class=\"token punctuation\">.</span>belongToRooms<span class=\"token punctuation\">.</span><span class=\"token function\">findIndex</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chatRoom</span> <span class=\"token operator\">=></span> chatRoom<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> roomId<span class=\"token punctuation\">)</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            user<span class=\"token punctuation\">.</span>belongToRooms<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong><em>Note: Redux does not allow to mutate the old state so, to avoid the duplication complexity and for the example purpose, we are mutating the state directly.</em></strong></p>\n<p>That is why unnormalized data is a concern for several reasons:</p>\n<ul>\n<li>When we have duplicated data in several places,\nit becomes harder to make sure it is updated appropriately.</li>\n<li>When we have nested structures, we need to create complex reducers\nwhich would parse the entire state tree to update the single field.</li>\n<li>An update to a deeply nested data object could force unrelated UI components\nto re-render even if the data did not change.</li>\n</ul>\n<p>So, to avoid all of the above issues, Normalization comes to the rescue.\nIt is a similar technique to what we generally do at the database level.</p>\n<ul>\n<li>Creating a separate table for each entity, whereas in the Redux store\nwe would treat all the entities as separate slices of a state\nand create separate reducers for each of them.</li>\n<li>We have primary keys on the data table,\nwhereas in the Redux store we store the individual entities in an object,\nwith the IDs of the entities as keys and the entities themselves as the values.</li>\n<li>At the database level, we store the references as IDs,\nsimilarly here in Redux store references to individual entities\nshould be done by storing the ID only.</li>\n</ul>\n<p>As we are treating the Redux store like a database,\nmany of the principles of database design apply here as well.\nFor example, in our case Chat room and the user have a many-to-many relationship,\nwe can model that using an intermediate entity called as chatRoomUser\nthat stores the IDs of the Chat room and User entities.</p>\n<p>So, after normalization our slices of state\nand their corresponding reducers would look like:-</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> chatRooms <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  byId<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'chatRoom1'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'general'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'chatRoom2'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'random'</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> users <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  byId<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'user1'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'user1'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'John'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'user2'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'user2'</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Smith'</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> chatRoomUsers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  byId<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'chatRoomUser1'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoomUser1'</span><span class=\"token punctuation\">,</span> chatRoomId<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom1'</span><span class=\"token punctuation\">,</span> userId<span class=\"token operator\">:</span> <span class=\"token string\">'user1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'chatRoomUser2'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoomUser2'</span><span class=\"token punctuation\">,</span> chatRoomId<span class=\"token operator\">:</span> <span class=\"token string\">'chatRoom2'</span><span class=\"token punctuation\">,</span> userId<span class=\"token operator\">:</span> <span class=\"token string\">'user2'</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// chatRoomReducer</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DELETE_CHAT_ROOM</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> roomId <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">;</span> \n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> chatRooms <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">delete</span> chatRooms<span class=\"token punctuation\">.</span>byId<span class=\"token punctuation\">[</span>roomId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// chatRoomUserReducer</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">DELETE_CHAT_ROOM_USER</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> roomId <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> action<span class=\"token punctuation\">.</span>payload<span class=\"token punctuation\">;</span> \n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> chatRoomUsers <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> state<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> chatRoomUsersIdsToBeDeleted <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span>chatRoomUsers<span class=\"token punctuation\">.</span>byId<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">.</span>chatRoomId <span class=\"token operator\">===</span> roomId<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span> <span class=\"token operator\">=></span> value<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      chatRoomUsersIdsToBeDeleted<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chatRoomUserId</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">delete</span> chatRoomUsers<span class=\"token punctuation\">.</span>byId<span class=\"token punctuation\">[</span>chatRoomUserId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now our state structure has become flat and, it has several advantages:-</p>\n<ul>\n<li>We have to update the slice of the state,\nno parsing of an entire state tree.</li>\n<li>Lookup has become simple like a dictionary\nwith a given chatRoomId or userId you can find an element in O(1).</li>\n<li>No complex reducers.</li>\n<li>Since each entity is separated, an update like changing the name of a Chat room would only require new copies of the “chatRooms > byId > chatRoom” portion of the tree.\nIt means the fewer portion of the State gets updates which result in fewer re-renders.</li>\n</ul>\n<p>It is important to normalize the state before it can be included in the state tree\nbecause APIs frequently send back data in a nested form.</p>","fields":{"slug":"/posts/redux-state-normalization","tagSlugs":["/tag/react/","/tag/redux/","/tag/javascript/"]},"frontmatter":{"date":"2021-09-20T18:00:37.121Z","description":"In complex applications, client apps have to store and manage a large amount of nested data, and if the data is not normalized, it can be incredibly time-consuming for a program to lookup nested data which could become a performance concern.","tags":["react","redux","javascript"],"title":"Normalizing Redux state to ensure good performance in React apps","socialImage":null}}},"pageContext":{"slug":"/posts/redux-state-normalization"}}}