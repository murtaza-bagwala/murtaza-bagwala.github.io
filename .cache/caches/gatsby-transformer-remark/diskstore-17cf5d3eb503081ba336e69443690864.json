{"expireTime":9007200872607001000,"key":"transformer-remark-markdown-ast-ceac2ca7648a814e144ada3f340f9d19-gatsby-remark-relative-imagesgatsby-remark-katexgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-autolink-headersgatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-external-links-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"In one of the projects, we submitted an app to AppStore for review and it was rejected due to the below-mentioned reason.","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":122,"offset":122},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":122,"offset":122},"indent":[]}},{"type":"paragraph","children":[{"type":"strong","children":[{"type":"emphasis","children":[{"type":"text","value":"We noticed that your app uses a third-party login service but does not offer Sign in with Apple.","position":{"start":{"line":4,"column":4,"offset":127},"end":{"line":4,"column":100,"offset":223},"indent":[]}}],"position":{"start":{"line":4,"column":3,"offset":126},"end":{"line":4,"column":101,"offset":224},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":124},"end":{"line":4,"column":103,"offset":226},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":124},"end":{"line":4,"column":103,"offset":226},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Apple has updated their guidelines which says Apps that exclusively use a third-party or social login service (such as Facebook Login, Google Sign-In, Sign in with Twitter, Sign In with LinkedIn, log in with Amazon, or WeChat Login) to set up or authenticate the user’s primary account with the app must also offer Sign in with Apple as an equivalent option.","position":{"start":{"line":6,"column":1,"offset":228},"end":{"line":6,"column":359,"offset":586},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":228},"end":{"line":6,"column":359,"offset":586},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Like other social login services, Apple too follows the same approach to authenticate the users like redirecting the users to the apple sign-in followed by API server validations.","position":{"start":{"line":8,"column":1,"offset":588},"end":{"line":8,"column":180,"offset":767},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":588},"end":{"line":8,"column":180,"offset":767},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"link","url":"#overview","title":null,"children":[],"data":{"hProperties":{"aria-label":"overview permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"Overview","position":{"start":{"line":10,"column":3,"offset":771},"end":{"line":10,"column":11,"offset":779},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":769},"end":{"line":10,"column":11,"offset":779},"indent":[]},"data":{"id":"overview","htmlAttributes":{"id":"overview"},"hProperties":{"id":"overview","style":"position:relative;"}}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"/apple-sign.jpg","alt":"alt","position":{"start":{"line":12,"column":1,"offset":781},"end":{"line":12,"column":24,"offset":804},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":781},"end":{"line":12,"column":24,"offset":804},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"After your app receives the user information, you can verify their associated identity token with the server to confirm that the token is not expired and ensure it has not been tampered with or replayed to your app.","position":{"start":{"line":14,"column":1,"offset":806},"end":{"line":14,"column":216,"offset":1021},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":806},"end":{"line":14,"column":216,"offset":1021},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Start by securely transmitting the identity token, authorization code, and userId to your API server and perform the below-mentioned validations:-","position":{"start":{"line":16,"column":1,"offset":1023},"end":{"line":16,"column":147,"offset":1169},"indent":[]}}],"position":{"start":{"line":16,"column":1,"offset":1023},"end":{"line":16,"column":147,"offset":1169},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"authorizationCode\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"c8adca8fb9eee455bbffae2314475dc15.0.rrruv.PFSuTcpvUNsetRanLgbp-w\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"identityToken\"</span><span class=\"token operator\">:</span> \"eyJraWQiOiJlWGF1bm1MIiwiYWxnIjoiUlMyNTYifQ<span class=\"token punctuation\">.</span>\n                   eyJpc3MiOiJodHRwczovL2FwcGxlaWQuYXBwbGUuY29tIiwiYXVkIjoiaG9zdC5leHAuRXhwb25lb\n                   nQiLCJleHAiOjE2MTM2NzE2MTEsImlhdCI6MTYxMzU4NTIxMSwic3ViIjoiMDAxMTQ1LjQ0MmMyNGU1NjQx\n                   NzQ4OTY4NmUxYWIyZjAwNTAzMjg4LjA2MjciLCJjX2hhc2giOiJWeU05eFg2SWNxTWVhdFZIbG90QTNRIiwi\n                   ZW1haWwiOiJ24fifWpheUB3ZWJvbmlzZWxhYi5jb20iLCJlbWFpbF92ZXJpZmllZCI6InRydWUiLCJhdXRoX\n                   <span class=\"token number\">3</span>RpbWUiOjE2MTM1ODUyMTEsIm5vbmNlX3N1cHBvcnRlZCI6dHJ1ZX0<span class=\"token punctuation\">.</span>ng7VcCSBdc1clxYzcnFBiqnuC1\n                   <span class=\"token number\">9</span>eHuOAUnEvRKRYNnYpqKXXwWxErteN6l1yPJOBqIz4eYWRer7ufkDhUpkPA45y6QUpGb25rFGREDidPefidcW5\n                   B23XNGwufCaCx2n49GUZFGsN4sJmrGx7aPhUHeFKmzT3K_gJUy3OOLnAeB3Enu<span class=\"token operator\">-</span>BKtvFQ0kAdl_hQQB9UpNbdq\n                   <span class=\"token constant\">D</span><span class=\"token operator\">-</span>qKEvfFS4oGemKCjW2SV0z4cdk_q4sUKIyr0i3zpz8DeErjbd2lsNY2<span class=\"token operator\">-</span><span class=\"token number\">6</span>RiG6CHCPEQonQA<span class=\"token operator\">-</span>AJcPQ2cpFf\n                   <span class=\"token number\">18</span>x9ZfSsYXI3zWRK_YTiz0QwAxKM7MhWdXVnAdi05u98D6qaAfN0FjVOYoREA\"<span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"user\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"001122.442c24e56417489686e1a3742f00503288.0327\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":18,"column":1,"offset":1171},"end":{"line":33,"column":4,"offset":2315},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":2,"children":[{"type":"link","url":"#validate-authorization-code","title":null,"children":[],"data":{"hProperties":{"aria-label":"validate authorization code permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"Validate authorization code","position":{"start":{"line":35,"column":3,"offset":2319},"end":{"line":35,"column":30,"offset":2346},"indent":[]}}],"position":{"start":{"line":35,"column":1,"offset":2317},"end":{"line":35,"column":30,"offset":2346},"indent":[]},"data":{"id":"validate-authorization-code","htmlAttributes":{"id":"validate-authorization-code"},"hProperties":{"id":"validate-authorization-code","style":"position:relative;"}}},{"type":"paragraph","children":[{"type":"text","value":"An authorization grant code that gets delivered to your API server, can be validated using this API","position":{"start":{"line":37,"column":1,"offset":2348},"end":{"line":37,"column":100,"offset":2447},"indent":[]}}],"position":{"start":{"line":37,"column":1,"offset":2348},"end":{"line":37,"column":100,"offset":2447},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token constant\">POST</span> https<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>appleid<span class=\"token punctuation\">.</span>apple<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>auth<span class=\"token operator\">/</span>token</code></pre></div>","position":{"start":{"line":39,"column":1,"offset":2449},"end":{"line":41,"column":4,"offset":2508},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"When you send an authorization request to the validation server, include the following form data parameters:","position":{"start":{"line":43,"column":1,"offset":2510},"end":{"line":43,"column":109,"offset":2618},"indent":[]}}],"position":{"start":{"line":43,"column":1,"offset":2510},"end":{"line":43,"column":109,"offset":2618},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">client_id<span class=\"token operator\">:</span> com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>com<span class=\"token punctuation\">;</span> <span class=\"token comment\">// AppId from Apple developers account</span>\n\n<span class=\"token comment\">// Need to generate it (Link in reference)</span>\n\nclient_secret<span class=\"token operator\">:</span> code<span class=\"token operator\">:</span> <span class=\"token string\">\"Authorization code received from App\"</span><span class=\"token punctuation\">;</span>\n\ngrant_type<span class=\"token operator\">:</span> <span class=\"token string\">\"authorization_code\"</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":45,"column":1,"offset":2620},"end":{"line":53,"column":4,"offset":2845},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The validation server returns status as 200 for a successful validation request or 400 for failed request.","position":{"start":{"line":55,"column":1,"offset":2847},"end":{"line":55,"column":107,"offset":2953},"indent":[]}}],"position":{"start":{"line":55,"column":1,"offset":2847},"end":{"line":55,"column":107,"offset":2953},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"link","url":"#verify-an-identity","title":null,"children":[],"data":{"hProperties":{"aria-label":"verify an identity permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"Verify an Identity","position":{"start":{"line":57,"column":3,"offset":2957},"end":{"line":57,"column":21,"offset":2975},"indent":[]}}],"position":{"start":{"line":57,"column":1,"offset":2955},"end":{"line":57,"column":21,"offset":2975},"indent":[]},"data":{"id":"verify-an-identity","htmlAttributes":{"id":"verify-an-identity"},"hProperties":{"id":"verify-an-identity","style":"position:relative;"}}},{"type":"paragraph","children":[{"type":"text","value":"Once the authorization code is validated, we need to verify the identity token(JWT) as well. Now in order to do that we need Apple’s public key to verify the signature.","position":{"start":{"line":59,"column":1,"offset":2977},"end":{"line":59,"column":169,"offset":3145},"indent":[]}}],"position":{"start":{"line":59,"column":1,"offset":2977},"end":{"line":59,"column":169,"offset":3145},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"To get the public key first we need to fetch JWKs (JSON Web Key). You can get the JWK keys from the following endpoint:","position":{"start":{"line":61,"column":1,"offset":3147},"end":{"line":61,"column":120,"offset":3266},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":3147},"end":{"line":61,"column":120,"offset":3266},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token constant\">GET</span> https<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>appleid<span class=\"token punctuation\">.</span>apple<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>auth<span class=\"token operator\">/</span>keys\n\nThe response would look like <span class=\"token keyword\">this</span><span class=\"token operator\">:</span>\n\n<span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"keys\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"kty\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RSA\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"YuyXoY\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"use\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sig\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"kty\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RSA\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"86D88Kf\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"use\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sig\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"kty\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RSA\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eXaunmL\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"use\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sig\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":63,"column":1,"offset":3268},"end":{"line":90,"column":4,"offset":3677},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Now, it has 3 keys, then how to select the right key from the set. So, If you decode the Identity JWT token that you got (put it in ","position":{"start":{"line":92,"column":1,"offset":3679},"end":{"line":92,"column":133,"offset":3811},"indent":[]}},{"type":"link","title":null,"url":"https://jwt.io/","children":[{"type":"text","value":"https://jwt.io/","position":{"start":{"line":92,"column":133,"offset":3811},"end":{"line":92,"column":148,"offset":3826},"indent":[]}}],"position":{"start":{"line":92,"column":133,"offset":3811},"end":{"line":92,"column":148,"offset":3826},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}},{"type":"text","value":"), in the header you will see something like this:","position":{"start":{"line":92,"column":148,"offset":3826},"end":{"line":92,"column":198,"offset":3876},"indent":[]}}],"position":{"start":{"line":92,"column":1,"offset":3679},"end":{"line":92,"column":198,"offset":3876},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eXaunmL\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":94,"column":1,"offset":3878},"end":{"line":99,"column":4,"offset":3936},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"so, The “kid” (key ID) Header Parameter is a hint indicating which key we need to use to verify the signature of an identity token. In our case, we should be using the 3rd one.","position":{"start":{"line":101,"column":1,"offset":3938},"end":{"line":101,"column":177,"offset":4114},"indent":[]}}],"position":{"start":{"line":101,"column":1,"offset":3938},"end":{"line":101,"column":177,"offset":4114},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Also note that we do not need to decode the JWT and handpick the key from the keys set, instead there are already built libraries in all the languages which do all these things for you.","position":{"start":{"line":103,"column":1,"offset":4116},"end":{"line":103,"column":186,"offset":4301},"indent":[]}}],"position":{"start":{"line":103,"column":1,"offset":4116},"end":{"line":103,"column":186,"offset":4301},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"for example, in NodeJS it would look like:-","position":{"start":{"line":105,"column":1,"offset":4303},"end":{"line":105,"column":44,"offset":4346},"indent":[]}}],"position":{"start":{"line":105,"column":1,"offset":4303},"end":{"line":105,"column":44,"offset":4346},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"request\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> jwtDecoder <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jsonwebtoken\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> jwksClient <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jwks-rsa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> token <span class=\"token operator\">=</span> <span class=\"token string\">\"recieved identity token\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> userId <span class=\"token operator\">=</span> <span class=\"token string\">\"received user id\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">var</span> client <span class=\"token operator\">=</span> <span class=\"token function\">jwksClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\t\tjwksUri<span class=\"token operator\">:</span> <span class=\"token string\">\"https://appleid.apple.com/auth/keys\"</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">function</span> <span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">header<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tclient<span class=\"token punctuation\">.</span><span class=\"token function\">getSigningKey</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span>kid<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">var</span> signingKey <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span>publicKey <span class=\"token operator\">||</span> key<span class=\"token punctuation\">.</span>rsaPublicKey<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> signingKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tjwtDecoder<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> getKey<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> algorithms<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token parameter\">err<span class=\"token punctuation\">,</span>\n\t\tdecoded</span>\n\t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> isValid <span class=\"token operator\">=</span>\n\t\t\tdecoded<span class=\"token punctuation\">.</span>user <span class=\"token operator\">===</span> userId <span class=\"token operator\">&amp;&amp;</span>\n\t\t\tdecoded<span class=\"token punctuation\">.</span>iss <span class=\"token operator\">===</span> <span class=\"token string\">\"https://appleid.apple.com\"</span> <span class=\"token operator\">&amp;&amp;</span>\n\t\t\tdecoded<span class=\"token punctuation\">.</span>aud <span class=\"token operator\">===</span> <span class=\"token string\">\"com.test.app\"</span> <span class=\"token operator\">&amp;&amp;</span>\n\t\t\tdecoded<span class=\"token punctuation\">.</span>exp <span class=\"token operator\">>=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":107,"column":1,"offset":4348},"end":{"line":141,"column":4,"offset":5202},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"We just need to specify the apple JWKs endpoint and algorithm and the library will take care of all the stuff, it does the following things under the hood:-","position":{"start":{"line":143,"column":1,"offset":5204},"end":{"line":143,"column":157,"offset":5360},"indent":[]}}],"position":{"start":{"line":143,"column":1,"offset":5204},"end":{"line":143,"column":157,"offset":5360},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Find kid from the jwt header.","position":{"start":{"line":145,"column":3,"offset":5364},"end":{"line":145,"column":32,"offset":5393},"indent":[]}}],"position":{"start":{"line":145,"column":3,"offset":5364},"end":{"line":145,"column":32,"offset":5393},"indent":[]}}],"position":{"start":{"line":145,"column":1,"offset":5362},"end":{"line":145,"column":32,"offset":5393},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Find the correct JWK from the Apple keys set.","position":{"start":{"line":146,"column":3,"offset":5396},"end":{"line":146,"column":48,"offset":5441},"indent":[]}}],"position":{"start":{"line":146,"column":3,"offset":5396},"end":{"line":146,"column":48,"offset":5441},"indent":[]}}],"position":{"start":{"line":146,"column":1,"offset":5394},"end":{"line":146,"column":48,"offset":5441},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Fetch the public key based on the selected JWK.","position":{"start":{"line":147,"column":3,"offset":5444},"end":{"line":147,"column":50,"offset":5491},"indent":[]}}],"position":{"start":{"line":147,"column":3,"offset":5444},"end":{"line":147,"column":50,"offset":5491},"indent":[]}}],"position":{"start":{"line":147,"column":1,"offset":5442},"end":{"line":147,"column":50,"offset":5491},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Verify and decode the JWT token.","position":{"start":{"line":148,"column":3,"offset":5494},"end":{"line":148,"column":35,"offset":5526},"indent":[]}}],"position":{"start":{"line":148,"column":3,"offset":5494},"end":{"line":148,"column":35,"offset":5526},"indent":[]}}],"position":{"start":{"line":148,"column":1,"offset":5492},"end":{"line":148,"column":35,"offset":5526},"indent":[]}}],"position":{"start":{"line":145,"column":1,"offset":5362},"end":{"line":148,"column":35,"offset":5526},"indent":[1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Now once we have verified and decoded the JWT token, we need to check","position":{"start":{"line":150,"column":1,"offset":5528},"end":{"line":150,"column":70,"offset":5597},"indent":[]}}],"position":{"start":{"line":150,"column":1,"offset":5528},"end":{"line":150,"column":70,"offset":5597},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"iss field contains ","position":{"start":{"line":152,"column":3,"offset":5601},"end":{"line":152,"column":22,"offset":5620},"indent":[]}},{"type":"link","title":null,"url":"https://appleid.apple.com","children":[{"type":"text","value":"https://appleid.apple.com","position":{"start":{"line":152,"column":22,"offset":5620},"end":{"line":152,"column":47,"offset":5645},"indent":[]}}],"position":{"start":{"line":152,"column":22,"offset":5620},"end":{"line":152,"column":47,"offset":5645},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}}],"position":{"start":{"line":152,"column":3,"offset":5601},"end":{"line":152,"column":47,"offset":5645},"indent":[]}}],"position":{"start":{"line":152,"column":1,"offset":5599},"end":{"line":152,"column":47,"offset":5645},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"aud field is the developer’s client_id","position":{"start":{"line":153,"column":3,"offset":5648},"end":{"line":153,"column":41,"offset":5686},"indent":[]}}],"position":{"start":{"line":153,"column":3,"offset":5648},"end":{"line":153,"column":41,"offset":5686},"indent":[]}}],"position":{"start":{"line":153,"column":1,"offset":5646},"end":{"line":153,"column":41,"offset":5686},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"The current time is earlier than the expired value of the token","position":{"start":{"line":154,"column":3,"offset":5689},"end":{"line":154,"column":66,"offset":5752},"indent":[]}}],"position":{"start":{"line":154,"column":3,"offset":5689},"end":{"line":154,"column":66,"offset":5752},"indent":[]}}],"position":{"start":{"line":154,"column":1,"offset":5687},"end":{"line":154,"column":66,"offset":5752},"indent":[]}}],"position":{"start":{"line":152,"column":1,"offset":5599},"end":{"line":154,"column":66,"offset":5752},"indent":[1,1]}},{"type":"heading","depth":2,"children":[{"type":"link","url":"#the-issue-with-the-expo-apple-sign-in","title":null,"children":[],"data":{"hProperties":{"aria-label":"the issue with the expo apple sign in permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"The issue with the Expo Apple Sign-In","position":{"start":{"line":156,"column":3,"offset":5756},"end":{"line":156,"column":40,"offset":5793},"indent":[]}}],"position":{"start":{"line":156,"column":1,"offset":5754},"end":{"line":156,"column":40,"offset":5793},"indent":[]},"data":{"id":"the-issue-with-the-expo-apple-sign-in","htmlAttributes":{"id":"the-issue-with-the-expo-apple-sign-in"},"hProperties":{"id":"the-issue-with-the-expo-apple-sign-in","style":"position:relative;"}}},{"type":"paragraph","children":[{"type":"text","value":"In order to implement Apple Sign-In in Expo, we used expo-apple-authentication package, followed the Expo docs, and set up what was needed in Apple Developer account and when we’re trying to sign in (with Apple), we were getting the expected credential (authorizationCode, name, email, identityToken, etc.). We were sending the code and identity token to our api server and according to the doc we were calling the auth endpoint ","position":{"start":{"line":158,"column":1,"offset":5795},"end":{"line":158,"column":430,"offset":6224},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">/auth/token</code>","position":{"start":{"line":158,"column":430,"offset":6224},"end":{"line":158,"column":443,"offset":6237},"indent":[]}},{"type":"text","value":" to validate the auth code but it was failling and returning ","position":{"start":{"line":158,"column":443,"offset":6237},"end":{"line":158,"column":504,"offset":6298},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">400 (“invalid_grant”)</code>","position":{"start":{"line":158,"column":504,"offset":6298},"end":{"line":158,"column":527,"offset":6321},"indent":[]}},{"type":"text","value":" back from Apple.","position":{"start":{"line":158,"column":527,"offset":6321},"end":{"line":158,"column":544,"offset":6338},"indent":[]}}],"position":{"start":{"line":158,"column":1,"offset":5795},"end":{"line":158,"column":544,"offset":6338},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"It really blocked us and Expo docs are not clear enough to help us debugged this issue, so it took us a day to finally debugged this issue, what we did was, tried decoding the identity (JWT) token (put it in ","position":{"start":{"line":160,"column":1,"offset":6340},"end":{"line":160,"column":209,"offset":6548},"indent":[]}},{"type":"link","title":null,"url":"https://jwt.io/","children":[{"type":"text","value":"https://jwt.io/","position":{"start":{"line":160,"column":209,"offset":6548},"end":{"line":160,"column":224,"offset":6563},"indent":[]}}],"position":{"start":{"line":160,"column":209,"offset":6548},"end":{"line":160,"column":224,"offset":6563},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}},{"type":"text","value":") and found that the ","position":{"start":{"line":160,"column":224,"offset":6563},"end":{"line":160,"column":245,"offset":6584},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">aud</code>","position":{"start":{"line":160,"column":245,"offset":6584},"end":{"line":160,"column":250,"offset":6589},"indent":[]}},{"type":"text","value":" was being sent as ","position":{"start":{"line":160,"column":250,"offset":6589},"end":{"line":160,"column":269,"offset":6608},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">host.exp.Exponent</code>","position":{"start":{"line":160,"column":269,"offset":6608},"end":{"line":160,"column":288,"offset":6627},"indent":[]}},{"type":"text","value":" as opposed to that of com.test.app. So, due to the ","position":{"start":{"line":160,"column":288,"offset":6627},"end":{"line":160,"column":340,"offset":6679},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">aud</code>","position":{"start":{"line":160,"column":340,"offset":6679},"end":{"line":160,"column":345,"offset":6684},"indent":[]}},{"type":"text","value":" mismatch, Apple wasn’t able to identify the auth code and was returning ","position":{"start":{"line":160,"column":345,"offset":6684},"end":{"line":160,"column":418,"offset":6757},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">400 (“invalid_grant”)</code>","position":{"start":{"line":160,"column":418,"offset":6757},"end":{"line":160,"column":441,"offset":6780},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":160,"column":441,"offset":6780},"end":{"line":160,"column":442,"offset":6781},"indent":[]}}],"position":{"start":{"line":160,"column":1,"offset":6340},"end":{"line":160,"column":442,"offset":6781},"indent":[]}},{"type":"html","lang":"javascript","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://appleid.apple.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"host.exp.Exponent\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1613802987</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1613716587</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":162,"column":1,"offset":6783},"end":{"line":169,"column":4,"offset":6914},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"So, It definitely doesn’t work in the Expo app but, it works well with the standalone build on TestFlight.","position":{"start":{"line":171,"column":1,"offset":6916},"end":{"line":171,"column":107,"offset":7022},"indent":[]}}],"position":{"start":{"line":171,"column":1,"offset":6916},"end":{"line":171,"column":107,"offset":7022},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"In our case, to get it working on expo we skipped calling an auth endpoint, and also while verifying an identity jwt token we skipped checking an aud field.","position":{"start":{"line":173,"column":1,"offset":7024},"end":{"line":173,"column":157,"offset":7180},"indent":[]}}],"position":{"start":{"line":173,"column":1,"offset":7024},"end":{"line":173,"column":157,"offset":7180},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"link","url":"#references","title":null,"children":[],"data":{"hProperties":{"aria-label":"references permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"References","position":{"start":{"line":175,"column":4,"offset":7185},"end":{"line":175,"column":14,"offset":7195},"indent":[]}}],"position":{"start":{"line":175,"column":1,"offset":7182},"end":{"line":175,"column":14,"offset":7195},"indent":[]},"data":{"id":"references","htmlAttributes":{"id":"references"},"hProperties":{"id":"references","style":"position:relative;"}}},{"type":"paragraph","children":[{"type":"text","value":"To generate the client_secret:- ","position":{"start":{"line":177,"column":1,"offset":7197},"end":{"line":177,"column":33,"offset":7229},"indent":[]}},{"type":"link","title":null,"url":"https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple#create-a-private-key-for-client-authentication","children":[{"type":"text","value":"https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple#create-a-private-key-for-client-authentication","position":{"start":{"line":177,"column":33,"offset":7229},"end":{"line":177,"column":158,"offset":7354},"indent":[]}}],"position":{"start":{"line":177,"column":33,"offset":7229},"end":{"line":177,"column":158,"offset":7354},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}}],"position":{"start":{"line":177,"column":1,"offset":7197},"end":{"line":177,"column":158,"offset":7354},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"v","position":{"start":{"line":179,"column":1,"offset":7356},"end":{"line":179,"column":2,"offset":7357},"indent":[]}},{"type":"link","title":null,"url":"https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens","children":[{"type":"text","value":"https://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens","position":{"start":{"line":179,"column":2,"offset":7357},"end":{"line":179,"column":91,"offset":7446},"indent":[]}}],"position":{"start":{"line":179,"column":2,"offset":7357},"end":{"line":179,"column":91,"offset":7446},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}}],"position":{"start":{"line":179,"column":1,"offset":7356},"end":{"line":179,"column":91,"offset":7446},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":180,"column":1,"offset":7447}}}}