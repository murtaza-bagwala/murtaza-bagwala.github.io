{"expireTime":9007200894070281000,"key":"transformer-remark-markdown-ast-de95412dd3d418f6a60205c66380aaaa-gatsby-remark-relative-imagesgatsby-remark-katexgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-autolink-headersgatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-external-links-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"We often hear ","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":15,"offset":15},"indent":[]}},{"type":"strong","children":[{"type":"emphasis","children":[{"type":"text","value":"Cache invalidation is a hard problem in computer science and could cause bugs","position":{"start":{"line":2,"column":18,"offset":18},"end":{"line":2,"column":95,"offset":95},"indent":[]}}],"position":{"start":{"line":2,"column":17,"offset":17},"end":{"line":2,"column":96,"offset":96},"indent":[]}}],"position":{"start":{"line":2,"column":15,"offset":15},"end":{"line":2,"column":98,"offset":98},"indent":[]}},{"type":"text","value":"\nbut sometimes, caching something that should not be cached is a potential source of bugs\nand security vulnerabilities.\nRails has a built-in mechanism for ","position":{"start":{"line":2,"column":98,"offset":98},"end":{"line":5,"column":36,"offset":253},"indent":[1,1,1]}},{"type":"link","title":null,"url":"https://guides.rubyonrails.org/caching_with_rails.html#fragment-caching","children":[{"type":"text","value":"Fragment Caching","position":{"start":{"line":5,"column":37,"offset":254},"end":{"line":5,"column":53,"offset":270},"indent":[]}}],"position":{"start":{"line":5,"column":36,"offset":253},"end":{"line":5,"column":127,"offset":344},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}},{"type":"text","value":",\nwhich stores part of the rendered view as a fragment. \nFor subsequent requests, the pre-saved fragment is used instead of rendering it again.","position":{"start":{"line":5,"column":127,"offset":344},"end":{"line":7,"column":87,"offset":487},"indent":[1,1]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":7,"column":87,"offset":487},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"But this could cause some serious bugs\nfor example, we could have an s3 URL helper which generates a unique presigned URL \nfor each of the product \nor one could write a form helper that outputs a request-specific auth token, \nin such cases, it is better to avoid Fragment Caching.","position":{"start":{"line":9,"column":1,"offset":489},"end":{"line":13,"column":55,"offset":769},"indent":[1,1,1,1]}}],"position":{"start":{"line":9,"column":1,"offset":489},"end":{"line":13,"column":55,"offset":769},"indent":[1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"link","url":"#before","title":null,"children":[],"data":{"hProperties":{"aria-label":"before permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"Before","position":{"start":{"line":15,"column":5,"offset":775},"end":{"line":15,"column":11,"offset":781},"indent":[]}}],"position":{"start":{"line":15,"column":1,"offset":771},"end":{"line":15,"column":11,"offset":781},"indent":[]},"data":{"id":"before","htmlAttributes":{"id":"before"},"hProperties":{"id":"before","style":"position:relative;"}}},{"type":"paragraph","children":[{"type":"text","value":"Using the ","position":{"start":{"line":17,"column":1,"offset":783},"end":{"line":17,"column":11,"offset":793},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">cache</code>","position":{"start":{"line":17,"column":11,"offset":793},"end":{"line":17,"column":18,"offset":800},"indent":[]}},{"type":"text","value":" helper we can implement fragment caching.","position":{"start":{"line":17,"column":18,"offset":800},"end":{"line":17,"column":60,"offset":842},"indent":[]}}],"position":{"start":{"line":17,"column":1,"offset":783},"end":{"line":17,"column":60,"offset":842},"indent":[]}},{"type":"paragraph","children":[{"type":"strong","children":[{"type":"text","value":"views/products/index.html.erb","position":{"start":{"line":19,"column":3,"offset":846},"end":{"line":19,"column":32,"offset":875},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":844},"end":{"line":19,"column":34,"offset":877},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":844},"end":{"line":19,"column":34,"offset":877},"indent":[]}},{"type":"html","lang":"ruby","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>table<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>thead<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span><span class=\"token constant\">Title</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span><span class=\"token constant\">Description</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>th<span class=\"token operator\">></span><span class=\"token constant\">Image</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>th<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>thead<span class=\"token operator\">></span>\n\n    <span class=\"token operator\">&lt;</span>tbody<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token variable\">@products</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">each</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>product<span class=\"token operator\">|</span> <span class=\"token string\">%>\n          &lt;% cache(product) do %></span>\n              <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token operator\">=</span> render product <span class=\"token string\">%>\n          &lt;% end %></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">end</span> <span class=\"token string\">%>\n    &lt;/tbody></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span></code></pre></div>","position":{"start":{"line":21,"column":1,"offset":879},"end":{"line":39,"column":4,"offset":1214},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"strong","children":[{"type":"text","value":"views/products/_product.html.erb","position":{"start":{"line":41,"column":3,"offset":1218},"end":{"line":41,"column":35,"offset":1250},"indent":[]}}],"position":{"start":{"line":41,"column":1,"offset":1216},"end":{"line":41,"column":37,"offset":1252},"indent":[]}}],"position":{"start":{"line":41,"column":1,"offset":1216},"end":{"line":41,"column":37,"offset":1252},"indent":[]}},{"type":"html","lang":"ruby","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token string\">%= product.title %>&lt;/td>\n    &lt;td>&lt;%=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token string\">%>&lt;/td></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token operator\">=</span> image_tag<span class=\"token punctuation\">(</span>generate_presigned_url<span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span>image_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string\">%>&lt;/td></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span></code></pre></div>","position":{"start":{"line":43,"column":1,"offset":1254},"end":{"line":49,"column":4,"offset":1427},"indent":[1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"But, here is a bug because, \nwe get a cached version of the product each time we are rendering the products \nthough, we are generating the unique presigned URL each time. \nTo resolve the above issue,\nwe need to include ","position":{"start":{"line":51,"column":1,"offset":1429},"end":{"line":55,"column":20,"offset":1648},"indent":[1,1,1,1]}},{"type":"html","value":"<code class=\"language-text\">cacheable</code>","position":{"start":{"line":55,"column":20,"offset":1648},"end":{"line":55,"column":31,"offset":1659},"indent":[]}},{"type":"text","value":" in the Product partial \nso that if someone tries to cache the product partial it would throw an ","position":{"start":{"line":55,"column":31,"offset":1659},"end":{"line":56,"column":73,"offset":1756},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">ActionView::Template::Error</code>","position":{"start":{"line":56,"column":73,"offset":1756},"end":{"line":56,"column":102,"offset":1785},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":56,"column":102,"offset":1785},"end":{"line":56,"column":103,"offset":1786},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1429},"end":{"line":56,"column":103,"offset":1786},"indent":[1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"link","url":"#after","title":null,"children":[],"data":{"hProperties":{"aria-label":"after permalink","class":"anchor before"},"hChildren":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]}},{"type":"text","value":"After","position":{"start":{"line":58,"column":5,"offset":1792},"end":{"line":58,"column":10,"offset":1797},"indent":[]}}],"position":{"start":{"line":58,"column":1,"offset":1788},"end":{"line":58,"column":10,"offset":1797},"indent":[]},"data":{"id":"after","htmlAttributes":{"id":"after"},"hProperties":{"id":"after","style":"position:relative;"}}},{"type":"html","lang":"ruby","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token string\">%= uncacheable! %>\n    &lt;td>&lt;%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string\">%>&lt;/td></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token string\">%= product.description %>&lt;/td>\n    &lt;td>&lt;%=</span> image_tag<span class=\"token punctuation\">(</span>generate_presigned_url<span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span>image_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string\">%>&lt;/td></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span></code></pre></div>","position":{"start":{"line":60,"column":1,"offset":1799},"end":{"line":67,"column":4,"offset":1996},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"which would result in","position":{"start":{"line":69,"column":1,"offset":1998},"end":{"line":69,"column":22,"offset":2019},"indent":[]}}],"position":{"start":{"line":69,"column":1,"offset":1998},"end":{"line":69,"column":22,"offset":2019},"indent":[]}},{"type":"html","lang":"ruby","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token constant\">ActionView</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Template</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Error</span> <span class=\"token punctuation\">(</span>can't be fragment cached<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>     <span class=\"token operator\">&lt;</span><span class=\"token string\">%= uncacheable! %>\n    3:   &lt;td>&lt;%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string\">%>&lt;/td></span>\n    <span class=\"token number\">4</span><span class=\"token punctuation\">:</span>   <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token string\">%= product.description %>&lt;/td>\n    5:   &lt;td>&lt;%=</span> image_tag<span class=\"token punctuation\">(</span>generate_presigned_url<span class=\"token punctuation\">(</span>product<span class=\"token punctuation\">.</span>image_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token string\">%>&lt;/td></span>\n  \n  app<span class=\"token operator\">/</span>views<span class=\"token operator\">/</span>products<span class=\"token operator\">/</span>_product<span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span>erb<span class=\"token punctuation\">:</span><span class=\"token number\">2</span></code></pre></div>","position":{"start":{"line":71,"column":1,"offset":2021},"end":{"line":80,"column":5,"offset":2340},"indent":[1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"we can also use the ","position":{"start":{"line":83,"column":1,"offset":2343},"end":{"line":83,"column":21,"offset":2363},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">caching?</code>","position":{"start":{"line":83,"column":21,"offset":2363},"end":{"line":83,"column":31,"offset":2373},"indent":[]}},{"type":"text","value":" helper to check whether the current code path is being cached \nor to enforce caching.","position":{"start":{"line":83,"column":31,"offset":2373},"end":{"line":84,"column":23,"offset":2459},"indent":[1]}}],"position":{"start":{"line":83,"column":1,"offset":2343},"end":{"line":84,"column":23,"offset":2459},"indent":[1]}},{"type":"html","lang":"ruby","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">  <span class=\"token operator\">&lt;</span>tr<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token string\">%= raise Exception.new \"This partial needs to be cached\" unless caching? %>\n    &lt;td>&lt;%=</span> product<span class=\"token punctuation\">.</span>title <span class=\"token string\">%>&lt;/td></span>\n    <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">%</span><span class=\"token operator\">=</span> product<span class=\"token punctuation\">.</span>description <span class=\"token string\">%>&lt;/td></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span></code></pre></div>","position":{"start":{"line":86,"column":1,"offset":2461},"end":{"line":92,"column":4,"offset":2642},"indent":[1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"For more discussion related to this change,\nplease refer to this\n","position":{"start":{"line":94,"column":1,"offset":2644},"end":{"line":96,"column":1,"offset":2709},"indent":[1,1]}},{"type":"link","title":null,"url":"https://github.com/rails/rails/pull/42365","children":[{"type":"text","value":"PR","position":{"start":{"line":96,"column":2,"offset":2710},"end":{"line":96,"column":4,"offset":2712},"indent":[]}}],"position":{"start":{"line":96,"column":1,"offset":2709},"end":{"line":96,"column":48,"offset":2756},"indent":[]},"data":{"hProperties":{"target":"_blank","rel":"nofollow noopener noreferrer"}}},{"type":"text","value":".","position":{"start":{"line":96,"column":48,"offset":2756},"end":{"line":96,"column":49,"offset":2757},"indent":[]}}],"position":{"start":{"line":94,"column":1,"offset":2644},"end":{"line":96,"column":49,"offset":2757},"indent":[1,1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":97,"column":1,"offset":2758}}}}