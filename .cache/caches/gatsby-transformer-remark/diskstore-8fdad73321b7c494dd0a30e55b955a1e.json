{"expireTime":9007200919798922000,"key":"transformer-remark-markdown-html-8d0e5439c8a252a6eaa67fa238948586-gatsby-remark-relative-imagesgatsby-remark-katexgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-autolink-headersgatsby-remark-prismjsgatsby-remark-copy-linked-filesgatsby-remark-smartypantsgatsby-remark-external-links-","val":"<p><a href=\"https://zuehlke.github.io/machines-code-people/articles/ci-cd-done-right.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CI/CD</a>\nis one of the most important practices of <a href=\"http://www.extremeprogramming.org/when.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">XP</a>.\nHaving set this up since the beginning can help in identify\nand fix issues earlier and faster time to market.\nHere, we at Saeloun make sure it gets set up since the start of the project.</p>\n<p>Let us start setting up a CI/CD for\n<a href=\"https://expo.dev/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Expo</a> react-native application.\nFirst, we will set up the CI process\nso it gets run on each of the branches we create,\nand then we will set up the CD process specific to the <code class=\"language-text\">develop</code> or <code class=\"language-text\">main</code> branch\nbecause we need to create builds for the latest changes that get merged to <code class=\"language-text\">develop</code> or <code class=\"language-text\">main</code>.</p>\n<h4 id=\"continuos-integration\" style=\"position:relative;\"><a href=\"#continuos-integration\" aria-label=\"continuos integration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Continuos Integration</h4>\n<ul>\n<li>As we are using\n<a href=\"https://github.com/features/actions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Github Actions</a>,\nwe need to create a <code class=\"language-text\">ci.yml</code> file inside the <code class=\"language-text\">.github/workflows</code> folder at the root of the project.</li>\n<li>Add the name of the workflow\nand the action on which we need to trigger the workflow.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name: CI\non: push\n{% endhighlight %}\n\n\n- As Workflows are composed of Jobs \nwe need to add a Job with the name `lint-and-test` \nas we will be linting the code and running the test cases. \nAlso, we need to specify the type of machine \nthat will process a job in our workflow.</code></pre></div>\n<p>name: CI\non: push</p>\n<p>jobs:\nlint-and-test:\nruns-on: ubuntu-latest\n{% endhighlight %}</p>\n<ul>\n<li>As Job is composed of a series of steps,\nwe need to add steps to cache and install the node modules,\nand finally run the lint and test cases.\nSo, this is what our final <code class=\"language-text\">ci.yml</code> file will look like.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name: CI\non: [push]\n\njobs:\n  lint-and-test:\n    runs-on: ubuntu-latest\n\n    # Steps represent a sequence of tasks that will be executed as part of the job\n    steps:\n      # Checks out your repository under $GITHUB_WORKSPACE, so your job can access it\n      - uses: actions/checkout@v2\n\n      - name: Find yarn cache location\n        id: yarn-cache\n        run: echo \"::set-output name=dir::$(yarn cache dir)\"\n\n      - name: JS package cache\n        uses: actions/cache@v1\n        with:\n          path: $(( steps.yarn-cache.outputs.dir ))\n          key: $(( runner.os ))-yarn-$(( hashFiles('**/yarn.lock') ))\n          restore-keys: |\n            $(( runner.os ))-yarn-\n\n      - name: Install Node Modules\n        run: yarn install\n\n      - name: Run Lint\n        run: yarn lint\n\n      - name: Run tests\n        run: yarn test  \n{% endhighlight %}\n\nOnce we add this file and push the code, Github Actions will run the workflow and we can see the results on Github Actions Tab.\n\n#### Continuos Deployment\n\nTo start with Continuos Deployment we need to first create an `EXPO_TOKEN` \nfrom [expo.dev](https://expo.dev/) \nand add it to the GitHub project's settings \nso that Expo allows GitHub Actions to create a build.\n\n- Navigate to [https://expo.dev/settings/access-tokens](https://expo.dev/settings/access-tokens).\n- Click \"Create\" to create a new access token.\n- Copy the token generated.\n- Navigate to [https://github.com/your-username/your-repo-name/settings/secrets/actions](https://github.com/your-username/your-repo-name/settings/secrets/actions), replacing \"your-username\" and \"your-repo-name\" with your project's info.\n- Click \"New repository secret\"\n- Make the secret's name \"EXPO_TOKEN\", then paste the access token in as the value.\n\nOnce this is done, \ncreate the `eas.json` file in your project root. \nThis file specifies different profiles \nwhich can be used to create builds for different environments \nfor example in our case \nwe created a `preview` profile for development builds. \nIt also specifies the type of packaging we need to use, \n`credentialsSource` to sign the build, \nand the `distribution` channel.  \n\nIn our case, `credentialsSource` is set to remote \nwhich means Expo will automatically create the credentials to sign the app.\n\n{% highlight json %}\n{\n  \"cli\": {\n    \"version\": \">= 0.52.0\"\n  },\n  \"build\": {\n    \"preview\": {\n      \"distribution\": \"internal\",\n      \"android\": {\n        \"buildType\": \"apk\"\n      },\n      \"credentialsSource\": \"remote\"\n    },\n    \"production\": {}\n  },\n  \"submit\": {\n    \"production\": {}\n  }\n}\n\n{% endhighlight %}\n\nNow we are ready to create a GitHub Actions workflow to create a build.\n\n- Create a `cd.yml` file inside the `.github/workflows` folder at the root of the project.\n- Add the name of the workflow and action along with the branch name on which we need to trigger the workflow.</code></pre></div>\n<p>name: build\non:\npush:\nbranches:\n- develop\n{% endhighlight %}</p>\n<ul>\n<li>Add the jobs <code class=\"language-text\">build</code> with <code class=\"language-text\">ubuntu-latest</code> as a runner machine.</li>\n<li>Add a step to fetch <code class=\"language-text\">EXPO_TOKEN</code> from the projectâ€™s settings.</li>\n<li>Add a step to set ENV.</li>\n<li>Add a step to install the expo.</li>\n<li>Add the steps to cache and install the node modules.</li>\n<li>Finally, add a step to create a build.</li>\n</ul>\n<p>Here is what our final <code class=\"language-text\">build.yml</code> looks like:- </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name: build\non: \n push:\n  branches:\n    - develop\n\njobs:\n  build:\n    name: EAS build\n    runs-on: ubuntu-latest\n    steps:\n      - name: Check for EXPO_TOKEN\n        run: |\n          if [ -z \"$(( secrets.EXPO_TOKEN ))\" ]; then\n            echo \"You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions\"\n            exit 1\n          fi\n\n      - name: \"Set ENV\"\n        run: echo \"$(BASE_URL)\"     \n        env:\n          BASE_URL: https://exampleapp.com    \n\n      - name: Checkout repository\n        uses: actions/checkout@v2\n\n      - name: Setup Node\n        uses: actions/setup-node@v2\n        with:\n          node-version: 16.x\n          cache: yarn\n\n      - name: Setup Expo\n        uses: expo/expo-github-action@v7\n        with:\n          expo-version: latest\n          eas-version: latest\n          token: $(( secrets.EXPO_TOKEN ))\n\n      - name: Find yarn cache\n        id: yarn-cache-path\n        run: echo \"::set-output name=dir::$(yarn cache dir)\"\n\n      - name: Restore cache\n        uses: actions/cache@v2\n        with:\n          path: \"$(( steps.yarn-cache-path.outputs.dir ))\"\n          key: \"$(( runner.os ))-yarn-$(( hashFiles('**/yarn.lock') ))\"\n          restore-keys: \"$(( runner.os ))-yarn-\"\n\n      - name: Install dependencies\n        run: yarn install --immutable\n\n      - name: Publish build\n        run: eas build --platform android --profile preview \n\n{% endhighlight %}\n\nAs it can be seen from the ***Publish build*** command \nwe are creating an android build using the `preview` profile as mentioned above.\n\nNow, once we push this file to develop branch, \nGitHub Actions will run this workflow \nand trigger the build to be created on the Expo platform.\nOnce the build is created, \nwe can always download it from Expo builds dashboard.\n\n{% include post_image.html file=\"expo.png\" %}</code></pre></div>"}