<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.5"/><meta name="theme-color" content="#F7A046"/><meta data-react-helmet="true" name="description" content="Each programming language has its version of memory management so, let us look into how Ruby does this under the hood."/><meta data-react-helmet="true" property="og:site_name" content="How does Ruby manage memory? - Tech Blog by Murtaza Bagwala"/><meta data-react-helmet="true" property="og:image" content="https://murtazabagwala.xyz/murtaza.jpeg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="How does Ruby manage memory? - Tech Blog by Murtaza Bagwala"/><meta data-react-helmet="true" name="twitter:description" content="Each programming language has its version of memory management so, let us look into how Ruby does this under the hood."/><meta data-react-helmet="true" name="twitter:image" content="https://murtazabagwala.xyz/murtaza.jpeg"/><style data-href="/styles.c0f2782165ca17191e81.css" data-identity="gatsby-global-css">html{font-size:100}body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#222;font-family:"Source Serif 4",ui-serif,Georgia,Cambria,Times New Roman,Times,serif;font-size:1.125rem;line-height:1.8;margin:0 0 0 calc(100vw - 100%);text-rendering:optimizeLegibility}h1,h2,h3,h4,h5,h6{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-weight:700}h1{font-size:2.8125rem;line-height:3.625rem;margin-bottom:1.8125rem;margin-top:7.25rem}h2{font-size:1.89844rem;line-height:2.71875rem}h2,h3{margin-bottom:.90625rem;margin-top:3.625rem}h3{font-size:1.54688rem;line-height:1.8125rem}h4{font-size:1.35rem;margin-top:2.71875rem}h4,h5{line-height:1.8125rem;margin-bottom:.90625rem}h5,h6{font-size:1.125rem;margin-top:4.53125rem}h6{line-height:1.8125rem;margin-bottom:.90625rem}img{height:auto;margin:1.25rem auto;max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);background-size:100% 26px;color:#222;height:1.625rem;margin:3.25rem auto;width:6.25rem}a{color:#5d93ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a046}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.8125rem}ul li{margin-bottom:.625rem;padding:0 .3125rem}p{-webkit-hyphens:manual;hyphens:manual;letter-spacing:.005em;line-height:1.8125rem;margin-bottom:1.8125rem;overflow-wrap:break-word;word-break:normal}blockquote{border-left:3px solid #e6e6e6;font-style:italic;padding:0 0 0 1rem;text-align:left}figure{display:block;height:auto;width:100%}figcaption{color:#222;font-size:.875rem;font-style:italic;line-height:1.35938rem;margin-bottom:0;margin-top:.45313rem;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.8125rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.Author-module--author__photo--f9011{background-clip:padding-box;border-radius:50%;display:inline-block;margin-bottom:0}.Author-module--author__title--c2773{font-size:1.26563rem;font-weight:600;line-height:2.03906rem;margin:.90625rem 0}.Author-module--author__title-link--eb7bd,.Author-module--author__title-link--eb7bd:focus,.Author-module--author__title-link--eb7bd:hover{color:#222}.Author-module--author__subtitle--69a39{color:#888;line-height:1.8125rem;margin-bottom:1.8125rem}.Icon-module--icon--1d7da{stroke-width:0;stroke:currentColor;fill:currentColor;speak:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;margin-left:.2em;margin-right:.2em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--09178{margin-bottom:1.8125rem}.Contacts-module--contacts__list--251ba{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:.625rem -.1875rem;padding:0;width:8.75rem}.Contacts-module--contacts__list-item--586d6{align-content:center;align-items:center;border:1px solid #ebebeb;border-radius:50%;display:flex;height:2.1875rem;justify-content:center;line-height:2.1875rem;margin:.25rem;padding:0;text-align:center;width:2.1875rem}.Contacts-module--contacts__list-item-link--5ca10{border:0;color:#222;display:flex}.Contacts-module--contacts__list-item-link--5ca10:focus,.Contacts-module--contacts__list-item-link--5ca10:hover{color:#5d93ff}.Copyright-module--copyright--2c602{color:#b6b6b6;font-size:.875rem}.Menu-module--menu--113a9{margin-bottom:1.8125rem}.Menu-module--menu__list--26b24{list-style:none;margin:0;padding:0}.Menu-module--menu__list-item--41e5e{margin:.625rem 0;padding:0}.Menu-module--menu__list-item-link--7b43a{border:0;color:#222;font-size:1.125rem;font-weight:400}.Menu-module--menu__list-item-link--7b43a:focus,.Menu-module--menu__list-item-link--7b43a:hover{border-bottom:1px solid #5d93ff;color:#5d93ff}.Menu-module--menu__list-item-link--active--fc794{border-bottom:1px solid #222;color:#222}.Sidebar-module--sidebar--1bfa1{width:100%}.Sidebar-module--sidebar__inner--e8eff{padding:1.5625rem 1.25rem 0;position:relative}@media screen and (min-width:685px){.Sidebar-module--sidebar--1bfa1{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--e8eff{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--e8eff:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);bottom:0;content:"";height:33.75rem;position:absolute;right:-10px;top:30px;width:.0625rem}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1bfa1{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--e8eff{padding:2.5rem}}.Category-module--cate--23a09{margin-bottom:1.8125rem}.Category-module--cate__item--83cef{margin-bottom:2.26563rem}.Category-module--cate__item--83cef:last-child{margin-bottom:.90625rem}.Category-module--cate__item-title--acb00{font-size:1.89844rem;line-height:2.71875rem;margin-bottom:.90625rem;margin-top:0}.Category-module--cate__item-title-link--6dc90{color:#222}.Category-module--cate__item-title-link--6dc90:focus,.Category-module--cate__item-title-link--6dc90:hover{border-bottom:1px solid #222;color:#222}.Category-module--cate__item-description--44e4f{font-size:1.125rem;line-height:1.8125rem;margin-bottom:1.35938rem}.Category-module--cate__item-meta-time--5fcb1{color:#222;font-size:.875rem;font-weight:600;text-transform:uppercase}.Category-module--cate__item-meta-divider--d84a3{margin:0 .3125rem}.Category-module--cate__item-meta-category-link--eff28{color:#f7a046;font-size:.875rem;font-weight:600;text-transform:uppercase}.Category-module--cate__item-meta-category-link--eff28:focus,.Category-module--cate__item-meta-category-link--eff28:hover{color:#5d93ff}.Category-module--cate__item-readmore--89320{color:#5d93ff;font-size:1.125rem}.Category-module--cate__item-readmore--89320:focus,.Category-module--cate__item-readmore--89320:hover{border-bottom:1px solid #5d93ff;color:#5d93ff}.Layout-module--layout--2c933{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--2c933:before{content:"";display:table}.Layout-module--layout--2c933:after{clear:both;content:"";display:table}.Feed-module--feed__item--619ca{margin-bottom:2.26563rem}.Feed-module--feed__item--619ca:last-child{margin-bottom:.90625rem}.Feed-module--feed__item-title--3920d{font-size:1.89844rem;line-height:2.71875rem;margin-bottom:.90625rem;margin-top:0}.Feed-module--feed__item-title-link--37758{color:#222}.Feed-module--feed__item-title-link--37758:focus,.Feed-module--feed__item-title-link--37758:hover{border-bottom:1px solid #222;color:#222}.Feed-module--feed__item-description--be821{font-size:1.125rem;line-height:1.8125rem;margin-bottom:1.35938rem}.Feed-module--feed__item-meta-time--a7603{color:#222;font-size:.875rem;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--d0e09{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--0d2d9{color:#f7a046;font-size:.875rem;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--0d2d9:focus,.Feed-module--feed__item-meta-category-link--0d2d9:hover{color:#5d93ff}.Feed-module--feed__item-readmore--3a66e{color:#5d93ff;font-size:1.125rem}.Feed-module--feed__item-readmore--3a66e:focus,.Feed-module--feed__item-readmore--3a66e:hover{border-bottom:1px solid #5d93ff;color:#5d93ff}.Page-module--page--24e03{margin-bottom:3.625rem}.Page-module--page__inner--8a961{padding:1.5625rem 1.25rem}.Page-module--page__title--5d268{font-size:2.8125rem;font-weight:600;line-height:3.625rem;margin-bottom:2.62813rem;margin-top:0}.Page-module--page__body--2ab2f{font-size:1.125rem;line-height:1.8125rem;margin:0 0 1.8125rem}@media screen and (min-width:685px){.Page-module--page--24e03{width:calc(58.275% - 12.5px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(12n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(12n+1){clear:both}.Page-module--page__inner--8a961{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--24e03{width:calc(66.6% - 10px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(3n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(3n+1){clear:both}.Page-module--page__inner--8a961{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--d61cb{display:flex;margin-top:3.625rem}.Pagination-module--pagination__prev--c31b0{text-align:left;width:50%}.Pagination-module--pagination__prev-link--949b1{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--949b1:focus,.Pagination-module--pagination__prev-link--949b1:hover{color:#5d93ff}.Pagination-module--pagination__prev-link--disable--351f0{color:#bbb;pointer-events:none}.Pagination-module--pagination__next--22ed3{text-align:right;width:50%}.Pagination-module--pagination__next-link--1f772{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--1f772:focus,.Pagination-module--pagination__next-link--1f772:hover{color:#5d93ff}.Pagination-module--pagination__next-link--disable--fa7b1{color:#bbb;pointer-events:none}.Author-module--author--1c58d{border-top:1px solid #e6e6e6;line-height:1.8125rem;margin-bottom:3.625rem;margin-top:1.8125rem;max-width:45rem;padding-top:1.25rem}.Author-module--author__bio-twitter--75212{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--1c58d{margin-left:auto;margin-right:auto}}.Content-module--content--80d58{margin:0 auto;max-width:64.0625rem;padding:0 .9375rem}.Content-module--content__title--f2408{font-size:2.25rem;font-weight:600;line-height:2.99063rem;margin:1.8125rem auto 0;max-width:45rem;text-align:left}.Content-module--content__body--0ce51{margin-left:auto;margin-right:auto;max-width:45rem;text-align:left}.Content-module--content__body--0ce51 figure{margin-bottom:1.8125rem}.Content-module--content__body--0ce51 figure blockquote{font-style:italic;margin-top:0;padding:1.8125rem 0;text-align:center}.Content-module--content__body--0ce51 figure blockquote p{font-size:1.89191rem;line-height:2.71875rem;margin-bottom:1.8125rem;margin-top:0;max-width:45rem}.Content-module--content__body--0ce51 a{text-decoration:underline}.Content-module--content__body--0ce51 img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--80d58{padding:0}.Content-module--content__title--f2408{font-size:3.375rem;line-height:4.07813rem;margin-bottom:2.71875rem;margin-top:4.07813rem}.Content-module--content__body--0ce51,.Content-module--content__body--0ce51 p{font-size:1.26563rem;line-height:2.03906rem;margin-bottom:2.03906rem}}.Meta-module--meta__date--0c1b6{font-style:italic}.Tags-module--tags--18589{margin-bottom:.90625rem}.Tags-module--tags__list--7df03{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--a981e{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3ec2a{border:1px solid #e6e6e6;border-radius:1.25rem;color:#222;display:inline-block;height:2.1875rem;line-height:2.1875rem;padding:0 1.5rem;text-decoration:none}.Tags-module--tags__list-item-link--3ec2a:focus,.Tags-module--tags__list-item-link--3ec2a:hover{color:#5d93ff}.Post-module--post__comments--27c37,.Post-module--post__footer--0bca4{margin:0 auto;max-width:45rem;padding:0 .9375rem}.Post-module--post__home-button--c395c{border:1px solid #e6e6e6;border-radius:1.25rem;color:#222;display:inline-block;font-size:1.125rem;font-weight:400;height:2.1875rem;line-height:2.1875rem;margin-left:auto;margin-right:auto;margin-top:1.8125rem;padding:0 1.5rem;text-align:center;white-space:nowrap}.Post-module--post__home-button--c395c:focus,.Post-module--post__home-button--c395c:hover{color:#5d93ff}@media screen and (min-width:960px){.Post-module--post__comments--27c37,.Post-module--post__footer--0bca4{padding:0}.Post-module--post__home-button--c395c{left:30px;margin:0;max-width:auto;position:fixed;top:30px}}</style><link rel="alternate" type="application/rss+xml" title="Tech Blog by Murtaza Bagwala" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-73379983-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-73379983-2', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=b56c185831be207d24b494cee04ea08d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=b56c185831be207d24b494cee04ea08d"/><title data-react-helmet="true">How does Ruby manage memory? - Tech Blog by Murtaza Bagwala</title><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;family=Source+Serif+4:opsz,wght@8..60,400;8..60,500;8..60,700&amp;display=swap" rel="stylesheet"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--2c933"><div><a class="Post-module--post__home-button--c395c" href="/">All Articles</a><div><div class="Content-module--content--80d58"><h1 class="Content-module--content__title--f2408">How does Ruby manage memory?</h1><div class="Content-module--content__body--0ce51"><p>In this two-part series, we aim to demystify the concepts behind Ruby’s memory management
and take a deeper look at how
<a href="https://bugs.ruby-lang.org/issues/18045" target="_blank" rel="nofollow noopener noreferrer">Variable Width Allocation</a>
can improve Ruby’s memory performance.</p>
<h3 id="rvalue" style="position:relative;"><a href="#rvalue" aria-label="rvalue permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RVALUE</h3>
<p>For Dynamic Memory allocation,
the Ruby program uses Heap memory
and the basic unit of the heap is a slot. Here, each slot occupies a value which is known as <strong>RVALUE</strong>.
This <strong>RVALUE</strong> comprises 40 bytes and a container for objects of all types (Array, String, Class).
Out of these 40 bytes, the initial 8 bytes are reserved for a flag, followed by 8 bytes of Klass pointer.
The remaining 24 bytes are reserved for object-specific fields.<br>
For example, for a Class object, it stores the pointer to an extension object
and for a String, it stores its content.</p>
<p><img src="/ruby-memory/r-value.jpg" alt="alt"></p>
<h3 id="heap-pages-" style="position:relative;"><a href="#heap-pages-" aria-label="heap pages  permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Heap Pages:-</h3>
<p>These 40-byte slots are organized into Heap pages.
Heap pages are containers of 16kb memory region,
accordingly, each Heap page has 408-409 slots
and all the slots on the same heap page are contiguous, with no gaps in between.</p>
<p><img src="/ruby-memory/heap-page.png" alt="alt"></p>
<h3 id="freelist-" style="position:relative;"><a href="#freelist-" aria-label="freelist  permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Freelist:-</h3>
<p>Initially, when the Heap page is created, all the slots are filled with the special RVALUE type <strong>T_NONE</strong>.
This represents an empty slot
and contains only a flag,
and a Klass pointer value known as <strong>next</strong>. This can be further pointed to another RVALUE.</p>
<p><img src="/ruby-memory/freelist1.png" alt="alt"></p>
<p>Also, when the Heap page is initialized,
Ruby sets a pointer called <strong>freelist</strong> pointer to the address of the first slot,
and then it starts visiting each of these slots.
As it gradually gets to each slot,
it sets the freelist pointer to the address of the current slot
and the current slot’s <strong>next</strong> pointer to the address of the previous slot.<br>
It derives the address of the previous slot from its last visit by creating a LinkedList of the empty slots called <strong>FreeList</strong>.</p>
<p><img src="/ruby-memory/freelist.gif" alt="alt"></p>
<h3 id="allocating-an-object" style="position:relative;"><a href="#allocating-an-object" aria-label="allocating an object permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Allocating an object</h3>
<p>So, when it needs to allocate an object, Ruby asks for an address of an empty slot from a Heap page.
Not to mention, the Heap page always returns a freelist pointer that has an address to the empty slot,
updates a freelist pointer with the address of the next empty slot
and also unlinks the current empty slot from the freelist.
This allows Ruby to put data into it.
The use of freelist keeps the object allocation operation constant in time,
so each time Ruby asks for an empty slot,
the Heap page just checks a value of the freelist pointer
and returns the address to Ruby.</p>
<p><img src="/ruby-memory/alloc1.png" alt="alt"></p>
<p>Allocating an object of type Rclass</p>
<p><img src="/ruby-memory/alloc2.png" alt="alt"></p>
<p>Allocating an object of type RString</p>
<p><img src="/ruby-memory/alloc3.png" alt="alt"></p>
<p>Allocating an object of type RArray</p>
<p><img src="/ruby-memory/alloc4.png" alt="alt"></p>
<p>And once all the slots are filled in,
<strong>Garbage Collector</strong> comes into action to reclaim spaces from the dead objects.</p>
<h3 id="garbage-collection" style="position:relative;"><a href="#garbage-collection" aria-label="garbage collection permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Garbage collection</h3>
<p>Ruby uses the <strong>Mark-Sweep-Compact</strong> garbage collection algorithm,
also when GC is active, the ruby code does not get executed.
Let us look into each of the GC phases:-</p>
<p><strong>Marking</strong>:- It is the phase where we determine which objects are alive
and which can be freed.
First, we mark the root-like global variables,
classes, etc. along with their children
until the mark stack is empty.</p>
<p>Let us consider that we have 2 Heap pages with 4 slots each from A to C and E to G.
Empty slots are free slots
and black slots are marked slots.
Here, the arrow shows the references,
for example, an arrow from A to G shows that object A
has an instance variable declared in G.</p>
<p><img src="/ruby-memory/mark1.png" alt="alt"></p>
<p>Let us start with the root elements we have - A
and B
and push them both on the Mark stack.
Now, let’s pop one element from the stack, mark it
and push its children on the stack.
Here pop A,
and push A’s child G to mark stack.
Now, pop B, mark it
and push its child E in the mark stack
and repeat this until we have the entire Mark stack as empty.
And, once it has marked all the objects along with their children,
it moves to the sweep phase.</p>
<p><img src="/ruby-memory/mark.gif" alt="alt"></p>
<p><strong>Sweeping</strong>:- It is the phase where all the unmarked objects can be reclaimed by the garbage collector.
So, after the marking step, this is how our heap pages look like:-</p>
<p><img src="/ruby-memory/sweep1.png" alt="alt"></p>
<p>Now, GC scans all the heap pages, checks for unmarked objects,
and frees the space.
In our case, we have C
and F as unmarked, therefore, GC will reclaim these spaces.</p>
<p><img src="/ruby-memory/sweep2.png" alt="alt"></p>
<p><strong>Compaction</strong>:- Compaction moves objects within the heap page to the start of the heap page
and it results in various benefits including reduced memory usage, faster garbage collection,
and better write performance.
Also, this involves 2 steps:-</p>
<ul>
<li><strong>Compact step</strong>:- This uses two cursors,</li>
</ul>
<p><strong>Free cursor</strong> which moves forward
and <strong>Compact cursor</strong> which moves backward.
This is why it is also called <strong>2 Fingers algorithm</strong>
and when these two cursors meet, this step is complete.</p>
<p>Let us understand this through an example.
Here, the white arrow is the Free cursor
and the black arrow is the Compact cursor.
The Free cursor begins from the start of the heap
and moves to the first free slot.
Then the Compact cursor starts from the end of the heap
and moves to the first filled slot.
It will then move the object at the compact cursor to the free slot
and leave a forwarding address at the original object to remember where this object was moved.
Now, continue moving the Free cursor forward
and the Compact cursor backward, repeat the above steps till these two cursors meet,
meaning that this step is complete.
After this step, we can see all the initial free slots are filled.</p>
<p><img src="/ruby-memory/compact.gif" alt="alt"></p>
<ul>
<li><strong>Update reference step</strong>:- In this step,</li>
</ul>
<p>we update the pointers to objects which were moved in the compaction step.
Let us continue with the previous example:-</p>
<p><img src="/ruby-memory/refer1.png" alt="alt"></p>
<p>We will now have just one cursor which will scan the objects linearly
and check if any of the objects have the reference to a forwarding address,
So, in our case object, <code class="language-text">A</code> and <code class="language-text">B</code> have the references to forwarding addresses
that says <code class="language-text">Moved to Heap Page 1</code>
and it will update the reference to the correct object which is <code class="language-text">G</code> and <code class="language-text">E</code>.</p>
<p><img src="/ruby-memory/refer2.png" alt="alt"></p>
<p>In this blog, we looked at how Ruby manages memory
and Garbage collection works,
in the next blog, we will see how Variable Width Allocation works.</p></div></div></div><div class="Post-module--post__footer--0bca4"><div><p class="Meta-module--meta__date--0c1b6">Published <!-- -->13 Apr 2022</p></div><div class="Tags-module--tags--18589"><ul class="Tags-module--tags__list--7df03"><li class="Tags-module--tags__list-item--a981e"><a class="Tags-module--tags__list-item-link--3ec2a" href="/tag/ruby/">ruby</a></li><li class="Tags-module--tags__list-item--a981e"><a class="Tags-module--tags__list-item-link--3ec2a" href="/tag/ruby-3/">ruby-3</a></li></ul></div><div class="Author-module--author--1c58d"><p>Software Craftsman. Exploring the world of AI and Machine Learning. Always learning.<a class="Author-module--author__bio-twitter--75212" href="https://www.twitter.com/undefined" rel="noopener noreferrer" target="_blank"><strong>Murtaza Bagwala</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--27c37"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/ruby-memory-management-part1/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-8eeca02ca2cadae77118.js\"],\"component---cache-caches-gatsby-plugin-offline-app-shell-js\":[\"/component---cache-caches-gatsby-plugin-offline-app-shell-js-02abafd21f3ca3501462.js\"],\"component---src-templates-categories-list-template-js\":[\"/component---src-templates-categories-list-template-js-9f2f78a4ca7152b7d57b.js\"],\"component---src-templates-category-template-js\":[\"/component---src-templates-category-template-js-99c6edb8a0294d995586.js\"],\"component---src-templates-index-template-js\":[\"/component---src-templates-index-template-js-2ab90758bc66874a5291.js\"],\"component---src-templates-not-found-template-js\":[\"/component---src-templates-not-found-template-js-0a045d9e2c3350657590.js\"],\"component---src-templates-page-template-js\":[\"/component---src-templates-page-template-js-337ce3be6ff6ba37fd6e.js\"],\"component---src-templates-post-template-js\":[\"/component---src-templates-post-template-js-b729e07ff7ff6def1433.js\"],\"component---src-templates-tag-template-js\":[\"/component---src-templates-tag-template-js-08527c0c65891dc3ca48.js\"],\"component---src-templates-tags-list-template-js\":[\"/component---src-templates-tags-list-template-js-43fc6c4b7be914b97648.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="9ed4d7a5b06ed7a3dfbe";</script><script src="/webpack-runtime-54ff2524547074b78bae.js" async></script><script src="/framework-df177803de5cb416bb55.js" async></script><script src="/app-8eeca02ca2cadae77118.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>