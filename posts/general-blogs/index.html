<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.14.5"/><meta name="theme-color" content="#F7A046"/><meta data-react-helmet="true" name="description" content="Now, Apple has mandated to provide Apple Sign-In as an equivalent option if your app is providing other social logins(FB, Gmail Twitter, etc) as well. In this guide I tried to simplify the entire process and how we resolved an issue we faced while using Expo for Apple Signin"/><meta data-react-helmet="true" property="og:site_name" content="Apple Sign-In and the issue we faced with Expo - Tech Blog by Murtaza Bagwala"/><meta data-react-helmet="true" property="og:image" content="https://murtazabagwala.xyz/murtaza.jpeg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Apple Sign-In and the issue we faced with Expo - Tech Blog by Murtaza Bagwala"/><meta data-react-helmet="true" name="twitter:description" content="Now, Apple has mandated to provide Apple Sign-In as an equivalent option if your app is providing other social logins(FB, Gmail Twitter, etc) as well. In this guide I tried to simplify the entire process and how we resolved an issue we faced while using Expo for Apple Signin"/><meta data-react-helmet="true" name="twitter:image" content="https://murtazabagwala.xyz/murtaza.jpeg"/><style data-href="/styles.c0f2782165ca17191e81.css" data-identity="gatsby-global-css">html{font-size:100}body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#222;font-family:"Source Serif 4",ui-serif,Georgia,Cambria,Times New Roman,Times,serif;font-size:1.125rem;line-height:1.8;margin:0 0 0 calc(100vw - 100%);text-rendering:optimizeLegibility}h1,h2,h3,h4,h5,h6{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-weight:700}h1{font-size:2.8125rem;line-height:3.625rem;margin-bottom:1.8125rem;margin-top:7.25rem}h2{font-size:1.89844rem;line-height:2.71875rem}h2,h3{margin-bottom:.90625rem;margin-top:3.625rem}h3{font-size:1.54688rem;line-height:1.8125rem}h4{font-size:1.35rem;margin-top:2.71875rem}h4,h5{line-height:1.8125rem;margin-bottom:.90625rem}h5,h6{font-size:1.125rem;margin-top:4.53125rem}h6{line-height:1.8125rem;margin-bottom:.90625rem}img{height:auto;margin:1.25rem auto;max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);background-size:100% 26px;color:#222;height:1.625rem;margin:3.25rem auto;width:6.25rem}a{color:#5d93ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a046}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.8125rem}ul li{margin-bottom:.625rem;padding:0 .3125rem}p{-webkit-hyphens:manual;hyphens:manual;letter-spacing:.005em;line-height:1.8125rem;margin-bottom:1.8125rem;overflow-wrap:break-word;word-break:normal}blockquote{border-left:3px solid #e6e6e6;font-style:italic;padding:0 0 0 1rem;text-align:left}figure{display:block;height:auto;width:100%}figcaption{color:#222;font-size:.875rem;font-style:italic;line-height:1.35938rem;margin-bottom:0;margin-top:.45313rem;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.8125rem}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.Author-module--author__photo--f9011{background-clip:padding-box;border-radius:50%;display:inline-block;margin-bottom:0}.Author-module--author__title--c2773{font-size:1.26563rem;font-weight:600;line-height:2.03906rem;margin:.90625rem 0}.Author-module--author__title-link--eb7bd,.Author-module--author__title-link--eb7bd:focus,.Author-module--author__title-link--eb7bd:hover{color:#222}.Author-module--author__subtitle--69a39{color:#888;line-height:1.8125rem;margin-bottom:1.8125rem}.Icon-module--icon--1d7da{stroke-width:0;stroke:currentColor;fill:currentColor;speak:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;margin-left:.2em;margin-right:.2em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--09178{margin-bottom:1.8125rem}.Contacts-module--contacts__list--251ba{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:.625rem -.1875rem;padding:0;width:8.75rem}.Contacts-module--contacts__list-item--586d6{align-content:center;align-items:center;border:1px solid #ebebeb;border-radius:50%;display:flex;height:2.1875rem;justify-content:center;line-height:2.1875rem;margin:.25rem;padding:0;text-align:center;width:2.1875rem}.Contacts-module--contacts__list-item-link--5ca10{border:0;color:#222;display:flex}.Contacts-module--contacts__list-item-link--5ca10:focus,.Contacts-module--contacts__list-item-link--5ca10:hover{color:#5d93ff}.Copyright-module--copyright--2c602{color:#b6b6b6;font-size:.875rem}.Menu-module--menu--113a9{margin-bottom:1.8125rem}.Menu-module--menu__list--26b24{list-style:none;margin:0;padding:0}.Menu-module--menu__list-item--41e5e{margin:.625rem 0;padding:0}.Menu-module--menu__list-item-link--7b43a{border:0;color:#222;font-size:1.125rem;font-weight:400}.Menu-module--menu__list-item-link--7b43a:focus,.Menu-module--menu__list-item-link--7b43a:hover{border-bottom:1px solid #5d93ff;color:#5d93ff}.Menu-module--menu__list-item-link--active--fc794{border-bottom:1px solid #222;color:#222}.Sidebar-module--sidebar--1bfa1{width:100%}.Sidebar-module--sidebar__inner--e8eff{padding:1.5625rem 1.25rem 0;position:relative}@media screen and (min-width:685px){.Sidebar-module--sidebar--1bfa1{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--e8eff{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--e8eff:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);bottom:0;content:"";height:33.75rem;position:absolute;right:-10px;top:30px;width:.0625rem}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1bfa1{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--e8eff{padding:2.5rem}}.Category-module--cate--23a09{margin-bottom:1.8125rem}.Category-module--cate__item--83cef{margin-bottom:2.26563rem}.Category-module--cate__item--83cef:last-child{margin-bottom:.90625rem}.Category-module--cate__item-title--acb00{font-size:1.89844rem;line-height:2.71875rem;margin-bottom:.90625rem;margin-top:0}.Category-module--cate__item-title-link--6dc90{color:#222}.Category-module--cate__item-title-link--6dc90:focus,.Category-module--cate__item-title-link--6dc90:hover{border-bottom:1px solid #222;color:#222}.Category-module--cate__item-description--44e4f{font-size:1.125rem;line-height:1.8125rem;margin-bottom:1.35938rem}.Category-module--cate__item-meta-time--5fcb1{color:#222;font-size:.875rem;font-weight:600;text-transform:uppercase}.Category-module--cate__item-meta-divider--d84a3{margin:0 .3125rem}.Category-module--cate__item-meta-category-link--eff28{color:#f7a046;font-size:.875rem;font-weight:600;text-transform:uppercase}.Category-module--cate__item-meta-category-link--eff28:focus,.Category-module--cate__item-meta-category-link--eff28:hover{color:#5d93ff}.Category-module--cate__item-readmore--89320{color:#5d93ff;font-size:1.125rem}.Category-module--cate__item-readmore--89320:focus,.Category-module--cate__item-readmore--89320:hover{border-bottom:1px solid #5d93ff;color:#5d93ff}.Layout-module--layout--2c933{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--2c933:before{content:"";display:table}.Layout-module--layout--2c933:after{clear:both;content:"";display:table}.Feed-module--feed__item--619ca{margin-bottom:2.26563rem}.Feed-module--feed__item--619ca:last-child{margin-bottom:.90625rem}.Feed-module--feed__item-title--3920d{font-size:1.89844rem;line-height:2.71875rem;margin-bottom:.90625rem;margin-top:0}.Feed-module--feed__item-title-link--37758{color:#222}.Feed-module--feed__item-title-link--37758:focus,.Feed-module--feed__item-title-link--37758:hover{border-bottom:1px solid #222;color:#222}.Feed-module--feed__item-description--be821{font-size:1.125rem;line-height:1.8125rem;margin-bottom:1.35938rem}.Feed-module--feed__item-meta-time--a7603{color:#222;font-size:.875rem;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--d0e09{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--0d2d9{color:#f7a046;font-size:.875rem;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--0d2d9:focus,.Feed-module--feed__item-meta-category-link--0d2d9:hover{color:#5d93ff}.Feed-module--feed__item-readmore--3a66e{color:#5d93ff;font-size:1.125rem}.Feed-module--feed__item-readmore--3a66e:focus,.Feed-module--feed__item-readmore--3a66e:hover{border-bottom:1px solid #5d93ff;color:#5d93ff}.Page-module--page--24e03{margin-bottom:3.625rem}.Page-module--page__inner--8a961{padding:1.5625rem 1.25rem}.Page-module--page__title--5d268{font-size:2.8125rem;font-weight:600;line-height:3.625rem;margin-bottom:2.62813rem;margin-top:0}.Page-module--page__body--2ab2f{font-size:1.125rem;line-height:1.8125rem;margin:0 0 1.8125rem}@media screen and (min-width:685px){.Page-module--page--24e03{width:calc(58.275% - 12.5px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(12n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(12n+1){clear:both}.Page-module--page__inner--8a961{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--24e03{width:calc(66.6% - 10px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(3n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(3n+1){clear:both}.Page-module--page__inner--8a961{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--d61cb{display:flex;margin-top:3.625rem}.Pagination-module--pagination__prev--c31b0{text-align:left;width:50%}.Pagination-module--pagination__prev-link--949b1{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--949b1:focus,.Pagination-module--pagination__prev-link--949b1:hover{color:#5d93ff}.Pagination-module--pagination__prev-link--disable--351f0{color:#bbb;pointer-events:none}.Pagination-module--pagination__next--22ed3{text-align:right;width:50%}.Pagination-module--pagination__next-link--1f772{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--1f772:focus,.Pagination-module--pagination__next-link--1f772:hover{color:#5d93ff}.Pagination-module--pagination__next-link--disable--fa7b1{color:#bbb;pointer-events:none}.Author-module--author--1c58d{border-top:1px solid #e6e6e6;line-height:1.8125rem;margin-bottom:3.625rem;margin-top:1.8125rem;max-width:45rem;padding-top:1.25rem}.Author-module--author__bio-twitter--75212{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--1c58d{margin-left:auto;margin-right:auto}}.Content-module--content--80d58{margin:0 auto;max-width:64.0625rem;padding:0 .9375rem}.Content-module--content__title--f2408{font-size:2.25rem;font-weight:600;line-height:2.99063rem;margin:1.8125rem auto 0;max-width:45rem;text-align:left}.Content-module--content__body--0ce51{margin-left:auto;margin-right:auto;max-width:45rem;text-align:left}.Content-module--content__body--0ce51 figure{margin-bottom:1.8125rem}.Content-module--content__body--0ce51 figure blockquote{font-style:italic;margin-top:0;padding:1.8125rem 0;text-align:center}.Content-module--content__body--0ce51 figure blockquote p{font-size:1.89191rem;line-height:2.71875rem;margin-bottom:1.8125rem;margin-top:0;max-width:45rem}.Content-module--content__body--0ce51 a{text-decoration:underline}.Content-module--content__body--0ce51 img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--80d58{padding:0}.Content-module--content__title--f2408{font-size:3.375rem;line-height:4.07813rem;margin-bottom:2.71875rem;margin-top:4.07813rem}.Content-module--content__body--0ce51,.Content-module--content__body--0ce51 p{font-size:1.26563rem;line-height:2.03906rem;margin-bottom:2.03906rem}}.Meta-module--meta__date--0c1b6{font-style:italic}.Tags-module--tags--18589{margin-bottom:.90625rem}.Tags-module--tags__list--7df03{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--a981e{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3ec2a{border:1px solid #e6e6e6;border-radius:1.25rem;color:#222;display:inline-block;height:2.1875rem;line-height:2.1875rem;padding:0 1.5rem;text-decoration:none}.Tags-module--tags__list-item-link--3ec2a:focus,.Tags-module--tags__list-item-link--3ec2a:hover{color:#5d93ff}.Post-module--post__comments--27c37,.Post-module--post__footer--0bca4{margin:0 auto;max-width:45rem;padding:0 .9375rem}.Post-module--post__home-button--c395c{border:1px solid #e6e6e6;border-radius:1.25rem;color:#222;display:inline-block;font-size:1.125rem;font-weight:400;height:2.1875rem;line-height:2.1875rem;margin-left:auto;margin-right:auto;margin-top:1.8125rem;padding:0 1.5rem;text-align:center;white-space:nowrap}.Post-module--post__home-button--c395c:focus,.Post-module--post__home-button--c395c:hover{color:#5d93ff}@media screen and (min-width:960px){.Post-module--post__comments--27c37,.Post-module--post__footer--0bca4{padding:0}.Post-module--post__home-button--c395c{left:30px;margin:0;max-width:auto;position:fixed;top:30px}}</style><link rel="alternate" type="application/rss+xml" title="Tech Blog by Murtaza Bagwala" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-73379983-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-73379983-2', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=b56c185831be207d24b494cee04ea08d" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=b56c185831be207d24b494cee04ea08d"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=b56c185831be207d24b494cee04ea08d"/><title data-react-helmet="true">Apple Sign-In and the issue we faced with Expo - Tech Blog by Murtaza Bagwala</title><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;family=Source+Serif+4:opsz,wght@8..60,400;8..60,500;8..60,700&amp;display=swap" rel="stylesheet"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--2c933"><div><a class="Post-module--post__home-button--c395c" href="/">All Articles</a><div><div class="Content-module--content--80d58"><h1 class="Content-module--content__title--f2408">Apple Sign-In and the issue we faced with Expo</h1><div class="Content-module--content__body--0ce51"><p>In one of the projects, we submitted an app to AppStore for review and it was rejected due to the below-mentioned reason.</p>
<p><strong><em>We noticed that your app uses a third-party login service but does not offer Sign in with Apple.</em></strong></p>
<p>Apple has updated their guidelines which says Apps that exclusively use a third-party or social login service (such as Facebook Login, Google Sign-In, Sign in with Twitter, Sign In with LinkedIn, log in with Amazon, or WeChat Login) to set up or authenticate the user’s primary account with the app must also offer Sign in with Apple as an equivalent option.</p>
<p>Like other social login services, Apple too follows the same approach to authenticate the users like redirecting the users to the apple sign-in followed by API server validations.</p>
<p>##Overview</p>
<p><img src="/apple-sign.jpg" alt="alt"></p>
<p>After your app receives the user information, you can verify their associated identity token with the server to confirm that the token is not expired and ensure it has not been tampered with or replayed to your app.</p>
<p>Start by securely transmitting the identity token, authorization code, and userId to your API server and perform the below-mentioned validations:-</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"> <span class="token punctuation">{</span>
  <span class="token string-property property">"authorizationCode"</span><span class="token operator">:</span> <span class="token string">"c8adca8fb9eee455bbffae2314475dc15.0.rrruv.PFSuTcpvUNsetRanLgbp-w"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"identityToken"</span><span class="token operator">:</span> "eyJraWQiOiJlWGF1bm1MIiwiYWxnIjoiUlMyNTYifQ<span class="token punctuation">.</span>
                   eyJpc3MiOiJodHRwczovL2FwcGxlaWQuYXBwbGUuY29tIiwiYXVkIjoiaG9zdC5leHAuRXhwb25lb
                   nQiLCJleHAiOjE2MTM2NzE2MTEsImlhdCI6MTYxMzU4NTIxMSwic3ViIjoiMDAxMTQ1LjQ0MmMyNGU1NjQx
                   NzQ4OTY4NmUxYWIyZjAwNTAzMjg4LjA2MjciLCJjX2hhc2giOiJWeU05eFg2SWNxTWVhdFZIbG90QTNRIiwi
                   ZW1haWwiOiJ24fifWpheUB3ZWJvbmlzZWxhYi5jb20iLCJlbWFpbF92ZXJpZmllZCI6InRydWUiLCJhdXRoX
                   3RpbWUiOjE2MTM1ODUyMTEsIm5vbmNlX3N1cHBvcnRlZCI6dHJ1ZX0<span class="token punctuation">.</span>ng7VcCSBdc1clxYzcnFBiqnuC1
                   9eHuOAUnEvRKRYNnYpqKXXwWxErteN6l1yPJOBqIz4eYWRer7ufkDhUpkPA45y6QUpGb25rFGREDidPefidcW5
                   B23XNGwufCaCx2n49GUZFGsN4sJmrGx7aPhUHeFKmzT3K_gJUy3OOLnAeB3Enu<span class="token operator">-</span>BKtvFQ0kAdl_hQQB9UpNbdq
                   <span class="token constant">D</span><span class="token operator">-</span>qKEvfFS4oGemKCjW2SV0z4cdk_q4sUKIyr0i3zpz8DeErjbd2lsNY2<span class="token operator">-</span>6RiG6CHCPEQonQA<span class="token operator">-</span>AJcPQ2cpFf
                   18x9ZfSsYXI3zWRK_YTiz0QwAxKM7MhWdXVnAdi05u98D6qaAfN0FjVOYoREA"<span class="token punctuation">,</span>
  <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"001122.442c24e56417489686e1a3742f00503288.0327"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>##Validate authorization code</p>
<p>An authorization grant code that gets delivered to your API server, can be validated using this API</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token constant">POST</span> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>appleid<span class="token punctuation">.</span>apple<span class="token punctuation">.</span>com<span class="token operator">/</span>auth<span class="token operator">/</span>token</code></pre></div>
<p>When you send an authorization request to the validation server, include the following form data parameters:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">client_id</span><span class="token operator">:</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span> <span class="token comment">// AppId from Apple developers account</span>

<span class="token comment">// Need to generate it (Link in reference)</span>

<span class="token literal-property property">client_secret</span><span class="token operator">:</span> code<span class="token operator">:</span> <span class="token string">"Authorization code received from App"</span><span class="token punctuation">;</span>

<span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">"authorization_code"</span><span class="token punctuation">;</span></code></pre></div>
<p>The validation server returns status as 200 for a successful validation request or 400 for failed request.</p>
<p>##Verify an Identity</p>
<p>Once the authorization code is validated, we need to verify the identity token(JWT) as well. Now in order to do that we need Apple’s public key to verify the signature.</p>
<p>To get the public key first we need to fetch JWKs (JSON Web Key). You can get the JWK keys from the following endpoint:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token constant">GET</span> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>appleid<span class="token punctuation">.</span>apple<span class="token punctuation">.</span>com<span class="token operator">/</span>auth<span class="token operator">/</span>keys

The response would look like <span class="token keyword">this</span><span class="token operator">:</span>

<span class="token punctuation">{</span>
  <span class="token string-property property">"keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"kid"</span><span class="token operator">:</span> <span class="token string">"YuyXoY"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"use"</span><span class="token operator">:</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"kid"</span><span class="token operator">:</span> <span class="token string">"86D88Kf"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"use"</span><span class="token operator">:</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">"kty"</span><span class="token operator">:</span> <span class="token string">"RSA"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"kid"</span><span class="token operator">:</span> <span class="token string">"eXaunmL"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"use"</span><span class="token operator">:</span> <span class="token string">"sig"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Now, it has 3 keys, then how to select the right key from the set. So, If you decode the Identity JWT token that you got (put it in <a href="https://jwt.io/" target="_blank" rel="nofollow noopener noreferrer">https://jwt.io/</a>), in the header you will see something like this:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token string-property property">"kid"</span><span class="token operator">:</span> <span class="token string">"eXaunmL"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"RS256"</span>
<span class="token punctuation">}</span></code></pre></div>
<p>so, The “kid” (key ID) Header Parameter is a hint indicating which key we need to use to verify the signature of an identity token. In our case, we should be using the 3rd one.</p>
<p>Also note that we do not need to decode the JWT and handpick the key from the keys set, instead there are already built libraries in all the languages which do all these things for you.</p>
<p>for example, in NodeJS it would look like:-</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> jwtDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jsonwebtoken"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> jwksClient <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"jwks-rsa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token string">"recieved identity token"</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> userId <span class="token operator">=</span> <span class="token string">"received user id"</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">jwksClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
		<span class="token literal-property property">jwksUri</span><span class="token operator">:</span> <span class="token string">"https://appleid.apple.com/auth/keys"</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">function</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token parameter">header<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		client<span class="token punctuation">.</span><span class="token function">getSigningKey</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>kid<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">var</span> signingKey <span class="token operator">=</span> key<span class="token punctuation">.</span>publicKey <span class="token operator">||</span> key<span class="token punctuation">.</span>rsaPublicKey<span class="token punctuation">;</span>
			<span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> signingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	jwtDecoder<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> getKey<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">algorithms</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"RS256"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
		<span class="token parameter">err<span class="token punctuation">,</span>
		decoded</span>
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> isValid <span class="token operator">=</span>
			decoded<span class="token punctuation">.</span>user <span class="token operator">===</span> userId <span class="token operator">&amp;&amp;</span>
			decoded<span class="token punctuation">.</span>iss <span class="token operator">===</span> <span class="token string">"https://appleid.apple.com"</span> <span class="token operator">&amp;&amp;</span>
			decoded<span class="token punctuation">.</span>aud <span class="token operator">===</span> <span class="token string">"com.test.app"</span> <span class="token operator">&amp;&amp;</span>
			decoded<span class="token punctuation">.</span>exp <span class="token operator">>=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>We just need to specify the apple JWKs endpoint and algorithm and the library will take care of all the stuff, it does the following things under the hood:-</p>
<ul>
<li>Find kid from the jwt header.</li>
<li>Find the correct JWK from the Apple keys set.</li>
<li>Fetch the public key based on the selected JWK.</li>
<li>Verify and decode the JWT token.</li>
</ul>
<p>Now once we have verified and decoded the JWT token, we need to check</p>
<ul>
<li>iss field contains <a href="https://appleid.apple.com" target="_blank" rel="nofollow noopener noreferrer">https://appleid.apple.com</a></li>
<li>aud field is the developer’s client_id</li>
<li>The current time is earlier than the expired value of the token</li>
</ul>
<p>##The issue with the Expo Apple Sign-In</p>
<p>In order to implement Apple Sign-In in Expo, we used expo-apple-authentication package, followed the Expo docs, and set up what was needed in Apple Developer account and when we’re trying to sign in (with Apple), we were getting the expected credential (authorizationCode, name, email, identityToken, etc.). We were sending the code and identity token to our api server and according to the doc we were calling the auth endpoint <code class="language-text">/auth/token</code> to validate the auth code but it was failling and returning <code class="language-text">400 (“invalid_grant”)</code> back from Apple.</p>
<p>It really blocked us and Expo docs are not clear enough to help us debugged this issue, so it took us a day to finally debugged this issue, what we did was, tried decoding the identity (JWT) token (put it in <a href="https://jwt.io/" target="_blank" rel="nofollow noopener noreferrer">https://jwt.io/</a>) and found that the <code class="language-text">aud</code> was being sent as <code class="language-text">host.exp.Exponent</code> as opposed to that of com.test.app. So, due to the <code class="language-text">aud</code> mismatch, Apple wasn’t able to identify the auth code and was returning <code class="language-text">400 (“invalid_grant”)</code>.</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  <span class="token string-property property">"iss"</span><span class="token operator">:</span> <span class="token string">"https://appleid.apple.com"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aud"</span><span class="token operator">:</span> <span class="token string">"host.exp.Exponent"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"exp"</span><span class="token operator">:</span> <span class="token number">1613802987</span><span class="token punctuation">,</span>
  <span class="token string-property property">"iat"</span><span class="token operator">:</span> <span class="token number">1613716587</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>So, It definitely doesn’t work in the Expo app but, it works well with the standalone build on TestFlight.</p>
<p>In our case, to get it working on expo we skipped calling an auth endpoint, and also while verifying an identity jwt token we skipped checking an aud field.</p>
<p>###References</p>
<p>To generate the client_secret:- <a href="https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple#create-a-private-key-for-client-authentication" target="_blank" rel="nofollow noopener noreferrer">https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple#create-a-private-key-for-client-authentication</a></p>
<p>vhttps://developer.apple.com/documentation/sign_in_with_apple/generate_and_validate_tokens</p></div></div></div><div class="Post-module--post__footer--0bca4"><div><p class="Meta-module--meta__date--0c1b6">Published <!-- -->22 Feb 2021</p></div><div class="Tags-module--tags--18589"><ul class="Tags-module--tags__list--7df03"><li class="Tags-module--tags__list-item--a981e"><a class="Tags-module--tags__list-item-link--3ec2a" href="/tag/apple-signin/">Apple Signin</a></li></ul></div><div class="Author-module--author--1c58d"><p>Software Craftsman. Exploring the world of AI and Machine Learning. Always learning.<a class="Author-module--author__bio-twitter--75212" href="https://www.twitter.com/undefined" rel="noopener noreferrer" target="_blank"><strong>Murtaza Bagwala</strong> on Twitter</a></p></div></div><div class="Post-module--post__comments--27c37"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/general-blogs/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-8eeca02ca2cadae77118.js\"],\"component---cache-caches-gatsby-plugin-offline-app-shell-js\":[\"/component---cache-caches-gatsby-plugin-offline-app-shell-js-02abafd21f3ca3501462.js\"],\"component---src-templates-categories-list-template-js\":[\"/component---src-templates-categories-list-template-js-9f2f78a4ca7152b7d57b.js\"],\"component---src-templates-category-template-js\":[\"/component---src-templates-category-template-js-99c6edb8a0294d995586.js\"],\"component---src-templates-index-template-js\":[\"/component---src-templates-index-template-js-2ab90758bc66874a5291.js\"],\"component---src-templates-not-found-template-js\":[\"/component---src-templates-not-found-template-js-0a045d9e2c3350657590.js\"],\"component---src-templates-page-template-js\":[\"/component---src-templates-page-template-js-337ce3be6ff6ba37fd6e.js\"],\"component---src-templates-post-template-js\":[\"/component---src-templates-post-template-js-b729e07ff7ff6def1433.js\"],\"component---src-templates-tag-template-js\":[\"/component---src-templates-tag-template-js-08527c0c65891dc3ca48.js\"],\"component---src-templates-tags-list-template-js\":[\"/component---src-templates-tags-list-template-js-43fc6c4b7be914b97648.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="9ed4d7a5b06ed7a3dfbe";</script><script src="/webpack-runtime-54ff2524547074b78bae.js" async></script><script src="/framework-df177803de5cb416bb55.js" async></script><script src="/app-8eeca02ca2cadae77118.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>